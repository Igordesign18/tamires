<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LABELLA WOMAN - Sistema de Gest√£o</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #d946ef;
            --primary-dark: #a21caf;
            --secondary: #ec4899;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --dark: #1f2937;
            --light: #f9fafb;
            --border: #e5e7eb;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #fce7f3 0%, #ddd6fe 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 12px 24px;
            border: none;
            background: var(--light);
            color: var(--dark);
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-tab:hover {
            background: #e5e7eb;
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 4px 12px rgba(217, 70, 239, 0.3);
        }

        .content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: linear-gradient(135deg, #fff 0%, #fafafa 100%);
            padding: 25px;
            border-radius: 12px;
            border: 2px solid var(--border);
            transition: all 0.3s;
        }

        .card:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 16px rgba(217, 70, 239, 0.2);
            transform: translateY(-5px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .card-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .card-label {
            font-size: 12px;
            color: #9ca3af;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover {
            box-shadow: 0 4px 12px rgba(217, 70, 239, 0.4);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(217, 70, 239, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        tbody tr:hover {
            background: var(--light);
        }

        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .badge-success {
            background: #d1fae5;
            color: var(--success);
        }

        .badge-warning {
            background: #fef3c7;
            color: var(--warning);
        }

        .badge-danger {
            background: #fee2e2;
            color: var(--danger);
        }

        .badge-info {
            background: #dbeafe;
            color: var(--info);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s;
        }

        @keyframes modalSlideIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--dark);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
            transition: all 0.3s;
        }

        .close-btn:hover {
            color: var(--danger);
            transform: rotate(90deg);
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .alert-success {
            background: #d1fae5;
            color: var(--success);
            border-left: 4px solid var(--success);
        }

        .alert-danger {
            background: #fee2e2;
            color: var(--danger);
            border-left: 4px solid var(--danger);
        }

        .alert-warning {
            background: #fef3c7;
            color: var(--warning);
            border-left: 4px solid var(--warning);
        }

        .variants-container {
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .variant-item {
            display: grid;
            grid-template-columns: 2fr 2fr 2fr 1fr 1fr auto;
            gap: 10px;
            align-items: end;
            margin-bottom: 10px;
            padding: 10px;
            background: var(--light);
            border-radius: 6px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--light);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .cart-total {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            text-align: right;
            padding: 20px;
            background: linear-gradient(135deg, #fce7f3, #e9d5ff);
            border-radius: 10px;
            margin-top: 20px;
        }

        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box input {
            padding-left: 40px;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .icon-btn {
            width: 35px;
            height: 35px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s;
        }

        .icon-btn-edit {
            background: #dbeafe;
            color: var(--info);
        }

        .icon-btn-delete {
            background: #fee2e2;
            color: var(--danger);
        }

        .icon-btn:hover {
            transform: scale(1.1);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
            }

            .nav-tabs {
                width: 100%;
                justify-content: center;
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .variant-item {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 10px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <span>üëó</span>
                LABELLA WOMAN
            </div>
            <nav class="nav-tabs">
                <button class="nav-tab active" onclick="showSection('dashboard')">
                    <span>üìä</span> Dashboard
                </button>
                <button class="nav-tab" onclick="showSection('products')">
                    <span>üëî</span> Produtos
                </button>
                <button class="nav-tab" onclick="showSection('stock')">
                    <span>üì¶</span> Estoque
                </button>
                <button class="nav-tab" onclick="showSection('pdv')">
                    <span>üõí</span> PDV
                </button>
                <button class="nav-tab" onclick="showSection('customers')">
                    <span>üë•</span> Clientes
                </button>
                <button class="nav-tab" onclick="showSection('sales')">
                    <span>üí∞</span> Vendas
                </button>
                <button class="nav-tab" onclick="showSection('cashier')">
                    <span>üíµ</span> Caixa
                </button>
            </nav>
        </div>

        <div class="content">
            <!-- PDV -->
            <div id="pdv" class="section active">
                <h2 style="margin-bottom: 25px; color: var(--dark);">Dashboard - Vis√£o Geral</h2>
                
                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Vendas Hoje</span>
                            <div class="card-icon" style="background: linear-gradient(135deg, #34d399, #10b981);">
                                <span style="color: white;">üí∞</span>
                            </div>
                        </div>
                        <div class="card-value" id="dashSalesToday">R$ 0,00</div>
                        <div class="card-label">Total de vendas do dia</div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Produtos Cadastrados</span>
                            <div class="card-icon" style="background: linear-gradient(135deg, #a78bfa, #8b5cf6);">
                                <span style="color: white;">üëî</span>
                            </div>
                        </div>
                        <div class="card-value" id="dashTotalProducts">0</div>
                        <div class="card-label">Produtos no cat√°logo</div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Itens em Estoque</span>
                            <div class="card-icon" style="background: linear-gradient(135deg, #60a5fa, #3b82f6);">
                                <span style="color: white;">üì¶</span>
                            </div>
                        </div>
                        <div class="card-value" id="dashTotalStock">0</div>
                        <div class="card-label">Total de itens dispon√≠veis</div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Alertas de Estoque</span>
                            <div class="card-icon" style="background: linear-gradient(135deg, #fbbf24, #f59e0b);">
                                <span style="color: white;">‚ö†Ô∏è</span>
                            </div>
                        </div>
                        <div class="card-value" id="dashLowStock">0</div>
                        <div class="card-label">Produtos com estoque baixo</div>
                    </div>
                </div>

                <div id="lowStockAlerts"></div>

                <h3 style="margin: 30px 0 20px; color: var(--dark);">Vendas Recentes</h3>
                <div class="table-container" id="recentSalesTable"></div>
            </div>

            <!-- PRODUTOS -->
            <div id="products" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 style="color: var(--dark);">Gerenciamento de Produtos</h2>
                    <button class="btn btn-primary" onclick="openProductModal()">
                        <span>‚ûï</span> Novo Produto
                    </button>
                </div>

                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="form-input" placeholder="Buscar produtos..." id="searchProducts" oninput="loadProducts()">
                </div>

                <div class="table-container" id="productsTable"></div>
            </div>

            <!-- ESTOQUE -->
            <div id="stock" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 style="color: var(--dark);">Controle de Estoque</h2>
                    <button class="btn btn-primary" onclick="exportStock()">
                        <span>üì•</span> Exportar
                    </button>
                </div>

                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="form-input" placeholder="Buscar no estoque..." id="searchStock" oninput="loadStock()">
                </div>

                <div class="table-container" id="stockTable"></div>
            </div>

            <!-- PDV -->
            <div id="pdv" class="section">
                <h2 style="margin-bottom: 25px; color: var(--dark);">Ponto de Venda</h2>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                    <div>
                        <div class="search-box">
                            <span class="search-icon">üîç</span>
                            <input type="text" class="form-input" placeholder="Buscar por nome, c√≥digo de barras ou SKU..." id="pdvSearch">
                        </div>
                        <div id="pdvProductsList"></div>
                    </div>

                    <div>
                        <div style="background: var(--light); padding: 20px; border-radius: 10px;">
                            <h3 style="margin-bottom: 15px;">Carrinho</h3>
                            <div id="pdvCart"></div>
                            <div class="cart-total">
                                Total: <span id="pdvTotal">R$ 0,00</span>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Cliente (Opcional)</label>
                                <select class="form-input" id="pdvCustomer">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Forma de Pagamento</label>
                                <select class="form-input" id="pdvPayment">
                                    <option value="dinheiro">üíµ Dinheiro</option>
                                    <option value="debito">üí≥ D√©bito</option>
                                    <option value="credito">üí≥ Cr√©dito</option>
                                    <option value="pix">üì± PIX</option>
                                </select>
                            </div>

                            <button class="btn btn-success" style="width: 100%; margin-top: 10px;" onclick="finalizeSale()">
                                <span>‚úì</span> Finalizar Venda
                            </button>
                            <button class="btn btn-danger" style="width: 100%; margin-top: 10px;" onclick="clearCart()">
                                <span>‚úï</span> Limpar Carrinho
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CLIENTES -->
            <div id="customers" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 style="color: var(--dark);">Gest√£o de Clientes</h2>
                    <button class="btn btn-primary" onclick="openCustomerModal()">
                        <span>‚ûï</span> Novo Cliente
                    </button>
                </div>

                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="form-input" placeholder="Buscar clientes..." id="searchCustomers" oninput="loadCustomers()">
                </div>

                <div class="table-container" id="customersTable"></div>
            </div>

            <!-- VENDAS -->
            <div id="sales" class="section">
                <h2 style="margin-bottom: 25px; color: var(--dark);">Hist√≥rico de Vendas</h2>
                
                <div class="form-row" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label class="form-label">Data Inicial</label>
                        <input type="date" class="form-input" id="salesDateStart">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data Final</label>
                        <input type="date" class="form-input" id="salesDateEnd">
                    </div>
                    <div class="form-group">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary" onclick="loadSales()">
                            <span>üîç</span> Filtrar
                        </button>
                    </div>
                </div>

                <div class="table-container" id="salesTable"></div>
            </div>

            <!-- CAIXA -->
            <div id="cashier" class="section">
                <h2 style="margin-bottom: 25px; color: var(--dark);">Controle de Caixa</h2>
                
                <div id="cashierStatus"></div>
                <div id="cashierContent"></div>
            </div>
        </div>
    </div>

    <!-- Modal Produto -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="productModalTitle">Novo Produto</h3>
                <button class="close-btn" onclick="closeProductModal()">√ó</button>
            </div>
            
            <form id="productForm">
                <input type="hidden" id="productId">
                
                <div class="form-group">
                    <label class="form-label">Nome do Produto *</label>
                    <input type="text" class="form-input" id="productName" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Descri√ß√£o</label>
                    <textarea class="form-input" id="productDescription" rows="3"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Categoria *</label>
                        <select class="form-input" id="productCategory" required>
                            <option value="">Selecione...</option>
                            <option value="vestidos">Vestidos</option>
                            <option value="blusas">Blusas</option>
                            <option value="calcas">Cal√ßas</option>
                            <option value="saias">Saias</option>
                            <option value="shorts">Shorts</option>
                            <option value="conjuntos">Conjuntos</option>
                            <option value="lingerie">Lingerie</option>
                            <option value="acessorios">Acess√≥rios</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Pre√ßo (R$) *</label>
                        <input type="number" class="form-input" id="productPrice" step="0.01" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">C√≥digo de Barras</label>
                        <input type="text" class="form-input" id="productBarcode" placeholder="EAN-13, EAN-8, UPC...">
                    </div>
                </div>

                <div class="variants-container">
                    <h4 style="margin-bottom: 15px;">Varia√ß√µes (Tamanho/Cor)</h4>
                    <div id="variantsContainer"></div>
                    <button type="button" class="btn btn-secondary" onclick="addVariantRow()">
                        <span>‚ûï</span> Adicionar Varia√ß√£o
                    </button>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <span>‚úì</span> Salvar
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Cliente -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="customerModalTitle">Novo Cliente</h3>
                <button class="close-btn" onclick="closeCustomerModal()">√ó</button>
            </div>
            
            <form id="customerForm">
                <input type="hidden" id="customerId">
                
                <div class="form-group">
                    <label class="form-label">Nome Completo *</label>
                    <input type="text" class="form-input" id="customerName" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">E-mail</label>
                        <input type="email" class="form-input" id="customerEmail">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Telefone *</label>
                        <input type="tel" class="form-input" id="customerPhone" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">CPF</label>
                    <input type="text" class="form-input" id="customerCpf" placeholder="000.000.000-00">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Data de Nascimento</label>
                        <input type="date" class="form-input" id="customerBirthday">
                    </div>

                    <div class="form-group">
                        <label class="form-label">WhatsApp</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="text" value="+55" style="width: 60px; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px;" readonly>
                            <input type="tel" class="form-input" id="customerWhatsapp" placeholder="75988888888" style="flex: 1;">
                        </div>
                        <small style="color: #6b7280; font-size: 12px;">Digite apenas n√∫meros: DDD + n√∫mero</small>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <span>‚úì</span> Salvar
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeCustomerModal()">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Detalhes da Venda -->
    <div id="saleDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Detalhes da Venda</h3>
                <button class="close-btn" onclick="closeSaleDetailsModal()">√ó</button>
            </div>
            <div id="saleDetailsContent"></div>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://yddxjerwtahjoyoebabh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkZHhqZXJ3dGFoam95b2ViYWJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNTY1NDQsImV4cCI6MjA3NzkzMjU0NH0.dnGklHi6V08pUZ5MvJmDXVn6hCduIxl8pi35L0kqLME';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Vari√°veis globais
        let cart = [];
        let currentCashRegister = null;

        // Verificar aniversariantes do dia
        async function checkBirthdays() {
            try {
                const { data: customers, error } = await supabase
                    .from('customers')
                    .select('*')
                    .not('birthday', 'is', null);

                if (error) throw error;

                const today = new Date();
                const todayMonth = today.getMonth() + 1;
                const todayDay = today.getDate();

                const birthdayCustomers = customers?.filter(customer => {
                    if (!customer.birthday) return false;
                    const birthday = new Date(customer.birthday + 'T00:00:00');
                    return birthday.getMonth() + 1 === todayMonth && birthday.getDate() === todayDay;
                }) || [];

                if (birthdayCustomers.length > 0) {
                    birthdayCustomers.forEach(customer => {
                        showBirthdayNotification(customer);
                    });
                }
            } catch (error) {
                console.error('Erro ao verificar aniversariantes:', error);
            }
        }

        function showBirthdayNotification(customer) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: white;
                padding: 20px;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.2);
                z-index: 3000;
                min-width: 350px;
                max-width: 400px;
                animation: slideInRight 0.3s;
                border-left: 4px solid var(--primary);
            `;
            
            const whatsappBtn = customer.whatsapp ? `
                <button class="btn btn-success" style="margin-right: 10px;" onclick="sendBirthdayWhatsApp('${customer.name}', '${customer.whatsapp}')">
                    <i class="fab fa-whatsapp"></i> Enviar WhatsApp
                </button>
            ` : '';
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-weight: bold; font-size: 16px;">
                    <i class="fas fa-birthday-cake" style="color: var(--primary); font-size: 24px;"></i>
                    Anivers√°rio Hoje!
                </div>
                <div style="color: #6b7280; line-height: 1.5; margin-bottom: 15px;">
                    <strong>${customer.name}</strong> est√° fazendo anivers√°rio hoje! 
                    ${customer.whatsapp ? 'Envie uma mensagem de felicita√ß√µes.' : ''}
                </div>
                <div style="display: flex; gap: 10px;">
                    ${whatsappBtn}
                    <button class="btn btn-secondary" onclick="this.closest('div').parentElement.remove()">
                        Fechar
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 15000);
        }

        function sendBirthdayWhatsApp(name, whatsapp) {
            const message = encodeURIComponent(`Ol√° ${name}! üéâüéÇ\n\nA equipe da LABELLA WOMAN deseja um Feliz Anivers√°rio! Que este dia seja repleto de alegrias e realiza√ß√µes.\n\nVenha nos visitar e aproveite nossas novidades! üíù`);
            const url = `https://wa.me/55${whatsapp}?text=${message}`;
            window.open(url, '_blank');
            
            document.querySelectorAll('div[style*="position: fixed"]').forEach(n => {
                if (n.innerHTML.includes('Anivers√°rio Hoje')) {
                    n.remove();
                }
            });
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeDatabase();
            await loadCashierStatus();
            await loadCustomersForPDV();
            await checkBirthdays();
            setDefaultDates();
        });

        // Inicializar banco de dados
        async function initializeDatabase() {
            try {
                // Verificar se as tabelas existem
                const { data: tables, error } = await supabase
                    .from('products')
                    .select('id')
                    .limit(1);

                if (error && error.code === '42P01') {
                    showAlert('Criando estrutura do banco de dados...', 'info');
                    await createTables();
                }
            } catch (error) {
                console.error('Erro ao inicializar banco:', error);
            }
        }

        // Criar tabelas
        async function createTables() {
            showAlert('Por favor, execute os seguintes comandos SQL no Supabase para criar as tabelas necess√°rias:', 'warning');
            
            const sql = `
-- Tabela de Produtos
CREATE TABLE IF NOT EXISTS products (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    category TEXT NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Tabela de Varia√ß√µes de Produtos
CREATE TABLE IF NOT EXISTS product_variants (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    product_id UUID REFERENCES products(id) ON DELETE CASCADE,
    size TEXT NOT NULL,
    color TEXT NOT NULL,
    sku TEXT,
    stock_quantity INTEGER DEFAULT 0,
    min_stock INTEGER DEFAULT 5,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Tabela de Clientes
CREATE TABLE IF NOT EXISTS customers (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name TEXT NOT NULL,
    email TEXT,
    phone TEXT NOT NULL,
    cpf TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Tabela de Vendas
CREATE TABLE IF NOT EXISTS sales (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    customer_id UUID REFERENCES customers(id),
    total DECIMAL(10,2) NOT NULL,
    payment_method TEXT NOT NULL,
    status TEXT DEFAULT 'completed',
    cash_register_id UUID,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Tabela de Itens da Venda
CREATE TABLE IF NOT EXISTS sale_items (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    sale_id UUID REFERENCES sales(id) ON DELETE CASCADE,
    product_variant_id UUID REFERENCES product_variants(id),
    quantity INTEGER NOT NULL,
    unit_price DECIMAL(10,2) NOT NULL,
    subtotal DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Tabela de Caixa
CREATE TABLE IF NOT EXISTS cash_register (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    opened_at TIMESTAMP DEFAULT NOW(),
    closed_at TIMESTAMP,
    initial_amount DECIMAL(10,2) DEFAULT 0,
    final_amount DECIMAL(10,2),
    status TEXT DEFAULT 'open'
);

-- √çndices
CREATE INDEX IF NOT EXISTS idx_product_variants_product_id ON product_variants(product_id);
CREATE INDEX IF NOT EXISTS idx_sales_created_at ON sales(created_at);
CREATE INDEX IF NOT EXISTS idx_sale_items_sale_id ON sale_items(sale_id);
`;

            console.log('SQL para criar tabelas:', sql);
            alert('Por favor, acesse o SQL Editor do Supabase e execute o script mostrado no console. Depois, recarregue a p√°gina.');
        }

        // Navega√ß√£o
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');

            // Carregar dados da se√ß√£o
            if (sectionId === 'products') loadProducts();
            if (sectionId === 'stock') loadStock();
            if (sectionId === 'pdv') loadPDVProducts();
            if (sectionId === 'customers') loadCustomers();
            if (sectionId === 'sales') loadSales();
            if (sectionId === 'dashboard') loadDashboard();
        }

        // Dashboard
        async function loadDashboard() {
            try {
                // Vendas de hoje
                const today = new Date().toISOString().split('T')[0];
                const { data: salesData } = await supabase
                    .from('sales')
                    .select('total')
                    .gte('created_at', today)
                    .eq('status', 'completed');

                const salesToday = salesData?.reduce((sum, sale) => sum + parseFloat(sale.total), 0) || 0;
                document.getElementById('dashSalesToday').textContent = formatCurrency(salesToday);

                // Total de produtos
                const { count: productCount } = await supabase
                    .from('products')
                    .select('*', { count: 'exact', head: true });
                document.getElementById('dashTotalProducts').textContent = productCount || 0;

                // Total de estoque
                const { data: stockData } = await supabase
                    .from('product_variants')
                    .select('stock_quantity');
                const totalStock = stockData?.reduce((sum, v) => sum + v.stock_quantity, 0) || 0;
                document.getElementById('dashTotalStock').textContent = totalStock;

                // Alertas de estoque baixo
                const { data: allVariants } = await supabase
                    .from('product_variants')
                    .select(`
                        id,
                        size,
                        color,
                        stock_quantity,
                        min_stock,
                        products (name)
                    `);
                
                // Filtrar varia√ß√µes com estoque baixo no JavaScript
                const lowStockData = allVariants?.filter(v => v.stock_quantity <= v.min_stock) || [];

                document.getElementById('dashLowStock').textContent = lowStockData?.length || 0;

                // Mostrar alertas
                const alertsDiv = document.getElementById('lowStockAlerts');
                if (lowStockData && lowStockData.length > 0) {
                    alertsDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <span>‚ö†Ô∏è</span>
                            <div>
                                <strong>Aten√ß√£o!</strong> ${lowStockData.length} produto(s) com estoque baixo.
                                <a href="#" onclick="showSection('stock'); return false;" style="color: var(--warning); text-decoration: underline;">Ver detalhes</a>
                            </div>
                        </div>
                    `;
                } else {
                    alertsDiv.innerHTML = '';
                }

                // Vendas recentes
                const { data: recentSales } = await supabase
                    .from('sales')
                    .select(`
                        id,
                        total,
                        payment_method,
                        created_at,
                        customers (name)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (recentSales && recentSales.length > 0) {
                    document.getElementById('recentSalesTable').innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Cliente</th>
                                    <th>Total</th>
                                    <th>Pagamento</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${recentSales.map(sale => `
                                    <tr>
                                        <td>${formatDateTime(sale.created_at)}</td>
                                        <td>${sale.customers?.name || 'Cliente n√£o informado'}</td>
                                        <td><strong>${formatCurrency(sale.total)}</strong></td>
                                        <td><span class="badge badge-info">${formatPaymentMethod(sale.payment_method)}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    document.getElementById('recentSalesTable').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üõí</div>
                            <p>Nenhuma venda realizada ainda</p>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
                showAlert('Erro ao carregar dashboard: ' + formatError(error), 'danger');
            }
        }

        // Produtos
        async function loadProducts() {
            const search = document.getElementById('searchProducts')?.value || '';
            
            try {
                let query = supabase
                    .from('products')
                    .select(`
                        id,
                        name,
                        category,
                        price,
                        created_at,
                        product_variants (
                            id,
                            size,
                            color,
                            sku,
                            stock_quantity
                        )
                    `)
                    .order('created_at', { ascending: false });

                if (search) {
                    query = query.ilike('name', `%${search}%`);
                }

                const { data: products, error } = await query;

                if (error) throw error;

                if (products && products.length > 0) {
                    document.getElementById('productsTable').innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Categoria</th>
                                    <th>Pre√ßo</th>
                                    <th>Varia√ß√µes</th>
                                    <th>Estoque Total</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${products.map(product => {
                                    const totalStock = product.product_variants.reduce((sum, v) => sum + v.stock_quantity, 0);
                                    return `
                                        <tr>
                                            <td><strong>${product.name}</strong></td>
                                            <td><span class="badge badge-info">${product.category}</span></td>
                                            <td><strong>${formatCurrency(product.price)}</strong></td>
                                            <td>${product.product_variants.length} varia√ß√µes</td>
                                            <td>${totalStock} unidades</td>
                                            <td>
                                                <div class="action-buttons">
                                                    <button class="icon-btn icon-btn-edit" onclick="editProduct('${product.id}')" title="Editar">
                                                        ‚úèÔ∏è
                                                    </button>
                                                    <button class="icon-btn icon-btn-delete" onclick="deleteProduct('${product.id}')" title="Excluir">
                                                        üóëÔ∏è
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    document.getElementById('productsTable').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üëî</div>
                            <p>Nenhum produto cadastrado</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
                showAlert('Erro ao carregar produtos: ' + formatError(error), 'danger');
            }
        }

        function openProductModal(productId = null) {
            document.getElementById('productModal').classList.add('active');
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('variantsContainer').innerHTML = '';
            document.getElementById('productModalTitle').textContent = 'Novo Produto';
            
            addVariantRow();

            if (productId) {
                loadProductForEdit(productId);
            }
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
        }

        async function loadProductForEdit(productId) {
            try {
                const { data: product, error } = await supabase
                    .from('products')
                    .select(`
                        *,
                        product_variants (*)
                    `)
                    .eq('id', productId)
                    .single();

                if (error) throw error;

                document.getElementById('productModalTitle').textContent = 'Editar Produto';
                document.getElementById('productId').value = product.id;
                document.getElementById('productName').value = product.name;
                document.getElementById('productDescription').value = product.description || '';
                document.getElementById('productCategory').value = product.category;
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productBarcode').value = product.barcode || '';

                document.getElementById('variantsContainer').innerHTML = '';
                product.product_variants.forEach(variant => {
                    addVariantRow(variant);
                });

            } catch (error) {
                console.error('Erro ao carregar produto:', error);
                showAlert('Erro ao carregar produto: ' + formatError(error), 'danger');
            }
        }

        function addVariantRow(variant = null) {
            const container = document.getElementById('variantsContainer');
            const row = document.createElement('div');
            row.className = 'variant-item';
            row.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Tamanho</label>
                    <select class="form-input variant-size" required>
                        <option value="">Selecione...</option>
                        <option value="PP" ${variant?.size === 'PP' ? 'selected' : ''}>PP</option>
                        <option value="P" ${variant?.size === 'P' ? 'selected' : ''}>P</option>
                        <option value="M" ${variant?.size === 'M' ? 'selected' : ''}>M</option>
                        <option value="G" ${variant?.size === 'G' ? 'selected' : ''}>G</option>
                        <option value="GG" ${variant?.size === 'GG' ? 'selected' : ''}>GG</option>
                        <option value="XG" ${variant?.size === 'XG' ? 'selected' : ''}>XG</option>
                        <option value="√önico" ${variant?.size === '√önico' ? 'selected' : ''}>√önico</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Cor</label>
                    <input type="text" class="form-input variant-color" value="${variant?.color || ''}" required>
                </div>
                <div class="form-group">
                    <label class="form-label">SKU</label>
                    <input type="text" class="form-input variant-sku" value="${variant?.sku || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Estoque</label>
                    <input type="number" class="form-input variant-stock" value="${variant?.stock_quantity || 0}" min="0" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Est. M√≠n</label>
                    <input type="number" class="form-input variant-min-stock" value="${variant?.min_stock || 5}" min="0" required>
                </div>
                <div class="form-group">
                    <label class="form-label">&nbsp;</label>
                    <button type="button" class="icon-btn icon-btn-delete" onclick="this.parentElement.parentElement.remove()">
                        üóëÔ∏è
                    </button>
                </div>
            `;
            if (variant) {
                row.dataset.variantId = variant.id;
            }
            container.appendChild(row);
        }

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const productId = document.getElementById('productId').value;
            const productData = {
                name: document.getElementById('productName').value,
                description: document.getElementById('productDescription').value,
                category: document.getElementById('productCategory').value,
                price: parseFloat(document.getElementById('productPrice').value),
                barcode: document.getElementById('productBarcode').value || null
            };

            const variants = [];
            document.querySelectorAll('.variant-item').forEach(item => {
                const size = item.querySelector('.variant-size').value;
                const color = item.querySelector('.variant-color').value;
                
                if (size && color) { // S√≥ adiciona se tiver tamanho e cor
                    variants.push({
                        id: item.dataset.variantId || null,
                        size: size,
                        color: color,
                        sku: item.querySelector('.variant-sku').value,
                        stock_quantity: parseInt(item.querySelector('.variant-stock').value) || 0,
                        min_stock: parseInt(item.querySelector('.variant-min-stock').value) || 5
                    });
                }
            });

            // Validar se h√° pelo menos uma varia√ß√£o
            if (variants.length === 0) {
                showAlert('Adicione pelo menos uma varia√ß√£o (tamanho e cor) para o produto', 'warning');
                return;
            }

            try {
                if (productId) {
                    // Atualizar produto
                    const { error: updateError } = await supabase
                        .from('products')
                        .update(productData)
                        .eq('id', productId);

                    if (updateError) throw updateError;

                    // Deletar varia√ß√µes antigas
                    await supabase
                        .from('product_variants')
                        .delete()
                        .eq('product_id', productId);

                    // Inserir novas varia√ß√µes
                    const variantsToInsert = variants.map(v => {
                        const { id, ...variantData } = v; // Remove o campo id
                        return {
                            ...variantData,
                            product_id: productId
                        };
                    });

                    const { error: variantsError } = await supabase
                        .from('product_variants')
                        .insert(variantsToInsert);

                    if (variantsError) throw variantsError;

                    showAlert('Produto atualizado com sucesso!', 'success');
                } else {
                    // Inserir novo produto
                    const { data: newProduct, error: insertError } = await supabase
                        .from('products')
                        .insert([productData])
                        .select()
                        .single();

                    if (insertError) throw insertError;

                    // Inserir varia√ß√µes
                    const variantsToInsert = variants.map(v => {
                        const { id, ...variantData } = v; // Remove o campo id
                        return {
                            ...variantData,
                            product_id: newProduct.id
                        };
                    });

                    const { error: variantsError } = await supabase
                        .from('product_variants')
                        .insert(variantsToInsert);

                    if (variantsError) throw variantsError;

                    showAlert('Produto cadastrado com sucesso!', 'success');
                }

                closeProductModal();
                loadProducts();
                loadDashboard();

            } catch (error) {
                console.error('Erro ao salvar produto:', error);
                showAlert('Erro ao salvar produto: ' + formatError(error), 'danger');
            }
        });

        async function deleteProduct(productId) {
            if (!confirm('Deseja realmente excluir este produto?')) return;

            try {
                const { error } = await supabase
                    .from('products')
                    .delete()
                    .eq('id', productId);

                if (error) throw error;

                showAlert('Produto exclu√≠do com sucesso!', 'success');
                loadProducts();
                loadDashboard();

            } catch (error) {
                console.error('Erro ao excluir produto:', error);
                showAlert('Erro ao excluir produto: ' + formatError(error), 'danger');
            }
        }

        // Estoque
        async function loadStock() {
            const search = document.getElementById('searchStock')?.value || '';
            
            try {
                let query = supabase
                    .from('product_variants')
                    .select(`
                        id,
                        size,
                        color,
                        sku,
                        stock_quantity,
                        min_stock,
                        products (name, category)
                    `)
                    .order('stock_quantity', { ascending: true });

                const { data: variants, error } = await query;

                if (error) throw error;

                let filteredVariants = variants;
                if (search) {
                    filteredVariants = variants.filter(v => 
                        v.products.name.toLowerCase().includes(search.toLowerCase()) ||
                        v.color.toLowerCase().includes(search.toLowerCase()) ||
                        v.sku?.toLowerCase().includes(search.toLowerCase())
                    );
                }

                if (filteredVariants && filteredVariants.length > 0) {
                    document.getElementById('stockTable').innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Tamanho</th>
                                    <th>Cor</th>
                                    <th>SKU</th>
                                    <th>Estoque</th>
                                    <th>Est. M√≠nimo</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredVariants.map(variant => {
                                    const isLowStock = variant.stock_quantity <= variant.min_stock;
                                    const statusBadge = isLowStock ? 
                                        `<span class="badge badge-warning">‚ö†Ô∏è Estoque Baixo</span>` : 
                                        `<span class="badge badge-success">‚úì OK</span>`;
                                    
                                    return `
                                        <tr>
                                            <td><strong>${variant.products.name}</strong></td>
                                            <td>${variant.size}</td>
                                            <td>${variant.color}</td>
                                            <td>${variant.sku || '-'}</td>
                                            <td><strong>${variant.stock_quantity}</strong></td>
                                            <td>${variant.min_stock}</td>
                                            <td>${statusBadge}</td>
                                            <td>
                                                <button class="btn btn-primary" style="padding: 8px 16px; font-size: 12px;" onclick="adjustStock('${variant.id}')">
                                                    üìù Ajustar
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    document.getElementById('stockTable').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì¶</div>
                            <p>Nenhum item em estoque</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar estoque:', error);
                showAlert('Erro ao carregar estoque: ' + formatError(error), 'danger');
            }
        }

        async function adjustStock(variantId) {
            const newStock = prompt('Digite a nova quantidade em estoque:');
            if (newStock === null) return;

            const quantity = parseInt(newStock);
            if (isNaN(quantity) || quantity < 0) {
                showAlert('Quantidade inv√°lida', 'danger');
                return;
            }

            try {
                const { error } = await supabase
                    .from('product_variants')
                    .update({ stock_quantity: quantity })
                    .eq('id', variantId);

                if (error) throw error;

                showAlert('Estoque atualizado com sucesso!', 'success');
                loadStock();
                loadDashboard();

            } catch (error) {
                console.error('Erro ao ajustar estoque:', error);
                showAlert('Erro ao ajustar estoque: ' + formatError(error), 'danger');
            }
        }

        function exportStock() {
            showAlert('Funcionalidade de exporta√ß√£o ser√° implementada em breve', 'info');
        }

        // PDV
        async function loadPDVProducts() {
            const search = document.getElementById('pdvSearch')?.value || '';
            
            try {
                let query = supabase
                    .from('product_variants')
                    .select(`
                        id,
                        size,
                        color,
                        sku,
                        stock_quantity,
                        products (id, name, price, category, barcode)
                    `)
                    .gt('stock_quantity', 0);

                const { data: variants, error } = await query;

                if (error) throw error;

                let filteredVariants = variants;
                if (search) {
                    filteredVariants = variants.filter(v => 
                        v.products.name.toLowerCase().includes(search.toLowerCase()) ||
                        v.color.toLowerCase().includes(search.toLowerCase()) ||
                        v.sku?.toLowerCase().includes(search.toLowerCase()) ||
                        v.products.barcode?.toLowerCase().includes(search.toLowerCase())
                    );
                }

                if (filteredVariants && filteredVariants.length > 0) {
                    document.getElementById('pdvProductsList').innerHTML = `
                        <div style="max-height: 500px; overflow-y: auto;">
                            ${filteredVariants.map(variant => `
                                <div class="card" style="margin-bottom: 10px; cursor: pointer;" onclick="addToCart('${variant.id}', '${variant.products.name}', '${variant.size}', '${variant.color}', ${variant.products.price}, ${variant.stock_quantity})">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>${variant.products.name}</strong><br>
                                            <small>${variant.size} - ${variant.color}</small>
                                            ${variant.products.barcode ? `<br><small style="color: #6b7280;"><i class="fas fa-barcode"></i> ${variant.products.barcode}</small>` : ''}
                                            <br><span class="badge badge-info"><i class="fas fa-box"></i> ${variant.stock_quantity} dispon√≠veis</span>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 20px; font-weight: bold; color: var(--primary);">
                                                ${formatCurrency(variant.products.price)}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    document.getElementById('pdvProductsList').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon"><i class="fas fa-search"></i></div>
                            <p>Nenhum produto encontrado</p>
                        </div>
                    `;
                }

                updateCart();

            } catch (error) {
                console.error('Erro ao carregar produtos PDV:', error);
                showAlert('Erro ao carregar produtos: ' + formatError(error), 'danger');
            }
        }

        document.getElementById('pdvSearch')?.addEventListener('input', loadPDVProducts);

        function addToCart(variantId, productName, size, color, price, maxStock) {
            const existingItem = cart.find(item => item.variantId === variantId);
            
            if (existingItem) {
                if (existingItem.quantity < maxStock) {
                    existingItem.quantity++;
                } else {
                    showAlert('Estoque insuficiente', 'warning');
                    return;
                }
            } else {
                cart.push({
                    variantId,
                    productName,
                    size,
                    color,
                    price,
                    quantity: 1,
                    maxStock
                });
            }

            updateCart();
        }

        function updateCart() {
            const cartDiv = document.getElementById('pdvCart');
            
            if (cart.length === 0) {
                cartDiv.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 20px;">Carrinho vazio</p>';
                document.getElementById('pdvTotal').textContent = 'R$ 0,00';
                return;
            }

            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            cartDiv.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <div style="flex: 1;">
                        <strong>${item.productName}</strong><br>
                        <small>${item.size} - ${item.color}</small>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button class="icon-btn" style="background: #fee2e2; color: var(--danger);" onclick="updateCartQuantity('${item.variantId}', -1)">
                            -
                        </button>
                        <span style="font-weight: bold; min-width: 30px; text-align: center;">${item.quantity}</span>
                        <button class="icon-btn" style="background: #d1fae5; color: var(--success);" onclick="updateCartQuantity('${item.variantId}', 1)">
                            +
                        </button>
                        <div style="min-width: 80px; text-align: right; font-weight: bold;">
                            ${formatCurrency(item.price * item.quantity)}
                        </div>
                        <button class="icon-btn icon-btn-delete" onclick="removeFromCart('${item.variantId}')">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `).join('');

            document.getElementById('pdvTotal').textContent = formatCurrency(total);
        }

        function updateCartQuantity(variantId, change) {
            const item = cart.find(i => i.variantId === variantId);
            if (!item) return;

            const newQuantity = item.quantity + change;

            if (newQuantity <= 0) {
                removeFromCart(variantId);
                return;
            }

            if (newQuantity > item.maxStock) {
                showAlert('Estoque insuficiente', 'warning');
                return;
            }

            item.quantity = newQuantity;
            updateCart();
        }

        function removeFromCart(variantId) {
            cart = cart.filter(item => item.variantId !== variantId);
            updateCart();
        }

        function clearCart() {
            if (cart.length === 0) return;
            if (!confirm('Deseja limpar o carrinho?')) return;
            
            cart = [];
            updateCart();
        }

        async function finalizeSale() {
            if (cart.length === 0) {
                showAlert('Carrinho vazio', 'warning');
                return;
            }

            // Verificar se o caixa est√° aberto
            if (!currentCashRegister || currentCashRegister.status !== 'open') {
                showAlert('Caixa fechado. Por favor, abra o caixa antes de realizar vendas.', 'warning');
                return;
            }

            const customerId = document.getElementById('pdvCustomer').value || null;
            const paymentMethod = document.getElementById('pdvPayment').value;
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            try {
                // Criar venda
                const { data: sale, error: saleError } = await supabase
                    .from('sales')
                    .insert([{
                        customer_id: customerId,
                        total: total,
                        payment_method: paymentMethod,
                        status: 'completed',
                        cash_register_id: currentCashRegister.id
                    }])
                    .select()
                    .single();

                if (saleError) throw saleError;

                // Criar itens da venda
                const saleItems = cart.map(item => ({
                    sale_id: sale.id,
                    product_variant_id: item.variantId,
                    quantity: item.quantity,
                    unit_price: item.price,
                    subtotal: item.price * item.quantity
                }));

                const { error: itemsError } = await supabase
                    .from('sale_items')
                    .insert(saleItems);

                if (itemsError) throw itemsError;

                // Atualizar estoque
                for (const item of cart) {
                    const { data: variant } = await supabase
                        .from('product_variants')
                        .select('stock_quantity')
                        .eq('id', item.variantId)
                        .single();

                    const newStock = variant.stock_quantity - item.quantity;

                    await supabase
                        .from('product_variants')
                        .update({ stock_quantity: newStock })
                        .eq('id', item.variantId);
                }

                showAlert('Venda realizada com sucesso!', 'success');
                
                // Limpar carrinho
                cart = [];
                updateCart();
                
                // Recarregar produtos
                loadPDVProducts();
                loadDashboard();

            } catch (error) {
                console.error('Erro ao finalizar venda:', error);
                showAlert('Erro ao finalizar venda: ' + formatError(error), 'danger');
            }
        }

        // Clientes
        async function loadCustomers() {
            const search = document.getElementById('searchCustomers')?.value || '';
            
            try {
                let query = supabase
                    .from('customers')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (search) {
                    query = query.or(`name.ilike.%${search}%,phone.ilike.%${search}%,email.ilike.%${search}%`);
                }

                const { data: customers, error } = await query;

                if (error) throw error;

                if (customers && customers.length > 0) {
                    document.getElementById('customersTable').innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>E-mail</th>
                                    <th>Telefone</th>
                                    <th>CPF</th>
                                    <th>Cadastro</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${customers.map(customer => `
                                    <tr>
                                        <td><strong>${customer.name}</strong></td>
                                        <td>${customer.email || '-'}</td>
                                        <td>${customer.phone}</td>
                                        <td>${customer.cpf || '-'}</td>
                                        <td>${formatDate(customer.created_at)}</td>
                                        <td>
                                            <div class="action-buttons">
                                                <button class="icon-btn icon-btn-edit" onclick="editCustomer('${customer.id}')" title="Editar">
                                                    ‚úèÔ∏è
                                                </button>
                                                <button class="icon-btn icon-btn-delete" onclick="deleteCustomer('${customer.id}')" title="Excluir">
                                                    üóëÔ∏è
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    document.getElementById('customersTable').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üë•</div>
                            <p>Nenhum cliente cadastrado</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
                showAlert('Erro ao carregar clientes: ' + formatError(error), 'danger');
            }
        }

        async function loadCustomersForPDV() {
            try {
                const { data: customers, error } = await supabase
                    .from('customers')
                    .select('id, name')
                    .order('name');

                if (error) throw error;

                const select = document.getElementById('pdvCustomer');
                select.innerHTML = '<option value="">Selecione...</option>';
                
                customers?.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = customer.name;
                    select.appendChild(option);
                });

            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
            }
        }

        function openCustomerModal(customerId = null) {
            document.getElementById('customerModal').classList.add('active');
            document.getElementById('customerForm').reset();
            document.getElementById('customerId').value = '';
            document.getElementById('customerModalTitle').textContent = 'Novo Cliente';

            if (customerId) {
                loadCustomerForEdit(customerId);
            }
        }

        function closeCustomerModal() {
            document.getElementById('customerModal').classList.remove('active');
        }

        async function loadCustomerForEdit(customerId) {
            try {
                const { data: customer, error } = await supabase
                    .from('customers')
                    .select('*')
                    .eq('id', customerId)
                    .single();

                if (error) throw error;

                document.getElementById('customerModalTitle').textContent = 'Editar Cliente';
                document.getElementById('customerId').value = customer.id;
                document.getElementById('customerName').value = customer.name;
                document.getElementById('customerEmail').value = customer.email || '';
                document.getElementById('customerPhone').value = customer.phone;
                document.getElementById('customerCpf').value = customer.cpf || '';
                document.getElementById('customerBirthday').value = customer.birthday || '';
                document.getElementById('customerWhatsapp').value = customer.whatsapp || '';

            } catch (error) {
                console.error('Erro ao carregar cliente:', error);
                showAlert('Erro ao carregar cliente: ' + formatError(error), 'danger');
            }
        }

        document.getElementById('customerForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const customerId = document.getElementById('customerId').value;
            const customerData = {
                name: document.getElementById('customerName').value,
                email: document.getElementById('customerEmail').value || null,
                phone: document.getElementById('customerPhone').value,
                cpf: document.getElementById('customerCpf').value || null,
                birthday: document.getElementById('customerBirthday').value || null,
                whatsapp: document.getElementById('customerWhatsapp').value || null
            };

            try {
                if (customerId) {
                    // Atualizar
                    const { error } = await supabase
                        .from('customers')
                        .update(customerData)
                        .eq('id', customerId);

                    if (error) throw error;
                    showAlert('Cliente atualizado com sucesso!', 'success');
                } else {
                    // Inserir
                    const { error } = await supabase
                        .from('customers')
                        .insert([customerData]);

                    if (error) throw error;
                    showAlert('Cliente cadastrado com sucesso!', 'success');
                }

                closeCustomerModal();
                loadCustomers();
                loadCustomersForPDV();

            } catch (error) {
                console.error('Erro ao salvar cliente:', error);
                showAlert('Erro ao salvar cliente: ' + formatError(error), 'danger');
            }
        });

        async function deleteCustomer(customerId) {
            if (!confirm('Deseja realmente excluir este cliente?')) return;

            try {
                const { error } = await supabase
                    .from('customers')
                    .delete()
                    .eq('id', customerId);

                if (error) throw error;

                showAlert('Cliente exclu√≠do com sucesso!', 'success');
                loadCustomers();
                loadCustomersForPDV();

            } catch (error) {
                console.error('Erro ao excluir cliente:', error);
                showAlert('Erro ao excluir cliente: ' + formatError(error), 'danger');
            }
        }

        // Vendas
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
            
            document.getElementById('salesDateStart').value = firstDay;
            document.getElementById('salesDateEnd').value = today;
        }

        async function loadSales() {
            const dateStart = document.getElementById('salesDateStart').value;
            const dateEnd = document.getElementById('salesDateEnd').value;
            
            try {
                let query = supabase
                    .from('sales')
                    .select(`
                        id,
                        total,
                        payment_method,
                        status,
                        created_at,
                        customers (name)
                    `)
                    .order('created_at', { ascending: false });

                if (dateStart) {
                    query = query.gte('created_at', dateStart);
                }
                if (dateEnd) {
                    const endDate = new Date(dateEnd);
                    endDate.setDate(endDate.getDate() + 1);
                    query = query.lt('created_at', endDate.toISOString().split('T')[0]);
                }

                const { data: sales, error } = await query;

                if (error) throw error;

                if (sales && sales.length > 0) {
                    const totalSales = sales.reduce((sum, sale) => sum + parseFloat(sale.total), 0);
                    
                    document.getElementById('salesTable').innerHTML = `
                        <div style="background: linear-gradient(135deg, #fce7f3, #e9d5ff); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-around; text-align: center;">
                                <div>
                                    <div style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">Total de Vendas</div>
                                    <div style="font-size: 28px; font-weight: bold; color: var(--primary);">${sales.length}</div>
                                </div>
                                <div>
                                    <div style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">Valor Total</div>
                                    <div style="font-size: 28px; font-weight: bold; color: var(--primary);">${formatCurrency(totalSales)}</div>
                                </div>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Cliente</th>
                                    <th>Total</th>
                                    <th>Pagamento</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sales.map(sale => `
                                    <tr>
                                        <td>${formatDateTime(sale.created_at)}</td>
                                        <td>${sale.customers?.name || 'Cliente n√£o informado'}</td>
                                        <td><strong>${formatCurrency(sale.total)}</strong></td>
                                        <td><span class="badge badge-info">${formatPaymentMethod(sale.payment_method)}</span></td>
                                        <td><span class="badge badge-success">‚úì Conclu√≠da</span></td>
                                        <td>
                                            <button class="btn btn-primary" style="padding: 8px 16px; font-size: 12px;" onclick="viewSaleDetails('${sale.id}')">
                                                üëÅÔ∏è Ver
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    document.getElementById('salesTable').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üí∞</div>
                            <p>Nenhuma venda encontrada no per√≠odo</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar vendas:', error);
                showAlert('Erro ao carregar vendas: ' + formatError(error), 'danger');
            }
        }

        async function viewSaleDetails(saleId) {
            try {
                const { data: sale, error: saleError } = await supabase
                    .from('sales')
                    .select(`
                        *,
                        customers (name, phone)
                    `)
                    .eq('id', saleId)
                    .single();

                if (saleError) throw saleError;

                const { data: items, error: itemsError } = await supabase
                    .from('sale_items')
                    .select(`
                        *,
                        product_variants (
                            size,
                            color,
                            products (name)
                        )
                    `)
                    .eq('sale_id', saleId);

                if (itemsError) throw itemsError;

                document.getElementById('saleDetailsContent').innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px; color: var(--dark);">Informa√ß√µes da Venda</h4>
                        <p><strong>Data/Hora:</strong> ${formatDateTime(sale.created_at)}</p>
                        <p><strong>Cliente:</strong> ${sale.customers?.name || 'Cliente n√£o informado'}</p>
                        <p><strong>Telefone:</strong> ${sale.customers?.phone || '-'}</p>
                        <p><strong>Pagamento:</strong> ${formatPaymentMethod(sale.payment_method)}</p>
                        <p><strong>Status:</strong> <span class="badge badge-success">‚úì Conclu√≠da</span></p>
                    </div>

                    <h4 style="margin-bottom: 10px; color: var(--dark);">Itens da Venda</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th>Varia√ß√£o</th>
                                <th>Qtd</th>
                                <th>Pre√ßo Unit.</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${items.map(item => `
                                <tr>
                                    <td>${item.product_variants.products.name}</td>
                                    <td>${item.product_variants.size} - ${item.product_variants.color}</td>
                                    <td>${item.quantity}</td>
                                    <td>${formatCurrency(item.unit_price)}</td>
                                    <td><strong>${formatCurrency(item.subtotal)}</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div class="cart-total" style="margin-top: 20px;">
                        Total: ${formatCurrency(sale.total)}
                    </div>
                `;

                document.getElementById('saleDetailsModal').classList.add('active');

            } catch (error) {
                console.error('Erro ao carregar detalhes da venda:', error);
                showAlert('Erro ao carregar detalhes da venda: ' + formatError(error), 'danger');
            }
        }

        function closeSaleDetailsModal() {
            document.getElementById('saleDetailsModal').classList.remove('active');
        }

        // Status do Caixa
        async function loadCashierStatus() {
            try {
                const { data: cashRegister, error } = await supabase
                    .from('cash_register')
                    .select('*')
                    .eq('status', 'open')
                    .order('opened_at', { ascending: false })
                    .limit(1)
                    .single();

                currentCashRegister = cashRegister;

                const statusDiv = document.getElementById('cashierStatus');
                
                if (cashRegister) {
                    const openedTime = new Date(cashRegister.opened_at).toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' });
                    
                    statusDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-lock-open"></i>
                            <div>
                                <strong>Caixa Aberto</strong><br>
                                Aberto em: ${openedTime} (Hor√°rio de Bras√≠lia)<br>
                                Valor inicial: ${formatCurrency(cashRegister.initial_amount)}
                            </div>
                        </div>
                    `;
                    
                    showAlert(`‚úì Caixa aberto desde ${openedTime}`, 'success');
                    await loadCashierMovements();
                } else {
                    statusDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-lock"></i>
                            <div>
                                <strong>Caixa Fechado</strong><br>
                                Por favor, abra o caixa para come√ßar a realizar vendas.
                            </div>
                        </div>
                    `;
                    showAlert('‚ö† Caixa est√° fechado. Abra o caixa para realizar vendas.', 'warning');
                    showOpenCashierForm();
                }

            } catch (error) {
                if (error.code === 'PGRST116') {
                    // Nenhum caixa aberto
                    currentCashRegister = null;
                    document.getElementById('cashierStatus').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-lock"></i>
                            <div>
                                <strong>Caixa Fechado</strong><br>
                                Por favor, abra o caixa para come√ßar a realizar vendas.
                            </div>
                        </div>
                    `;
                    showAlert('‚ö† Caixa est√° fechado. Abra o caixa para realizar vendas.', 'warning');
                    showOpenCashierForm();
                } else {
                    console.error('Erro ao carregar status do caixa:', error);
                }
            }
        }

        function showOpenCashierForm() {
            document.getElementById('cashierContent').innerHTML = `
                <div style="max-width: 400px; margin: 0 auto; padding: 20px;">
                    <h3 style="margin-bottom: 20px; text-align: center;">Abrir Caixa</h3>
                    <div class="form-group">
                        <label class="form-label">Valor Inicial (R$)</label>
                        <input type="number" class="form-input" id="initialAmount" step="0.01" value="0.00">
                    </div>
                    <button class="btn btn-primary" style="width: 100%;" onclick="openCashier()">
                        <span>‚úì</span> Abrir Caixa
                    </button>
                </div>
            `;
        }

        async function openCashier() {
            const initialAmount = parseFloat(document.getElementById('initialAmount').value);

            if (isNaN(initialAmount) || initialAmount < 0) {
                showAlert('Valor inicial inv√°lido', 'danger');
                return;
            }

            try {
                const { data: cashRegister, error } = await supabase
                    .from('cash_register')
                    .insert([{
                        initial_amount: initialAmount,
                        status: 'open'
                    }])
                    .select()
                    .single();

                if (error) throw error;

                showAlert('Caixa aberto com sucesso!', 'success');
                await loadCashierStatus();

            } catch (error) {
                console.error('Erro ao abrir caixa:', error);
                showAlert('Erro ao abrir caixa: ' + formatError(error), 'danger');
            }
        }

        async function loadCashierMovements() {
            if (!currentCashRegister) return;

            try {
                const { data: sales, error } = await supabase
                    .from('sales')
                    .select('*')
                    .eq('cash_register_id', currentCashRegister.id)
                    .eq('status', 'completed')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const totalSales = sales?.reduce((sum, sale) => sum + parseFloat(sale.total), 0) || 0;
                const currentTotal = parseFloat(currentCashRegister.initial_amount) + totalSales;

                // Agrupar por forma de pagamento
                const paymentSummary = {};
                sales?.forEach(sale => {
                    if (!paymentSummary[sale.payment_method]) {
                        paymentSummary[sale.payment_method] = 0;
                    }
                    paymentSummary[sale.payment_method] += parseFloat(sale.total);
                });

                document.getElementById('cashierContent').innerHTML = `
                    <div style="background: linear-gradient(135deg, #fce7f3, #e9d5ff); padding: 30px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; text-align: center;">
                            <div>
                                <div style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">Valor Inicial</div>
                                <div style="font-size: 24px; font-weight: bold; color: var(--dark);">${formatCurrency(currentCashRegister.initial_amount)}</div>
                            </div>
                            <div>
                                <div style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">Total em Vendas</div>
                                <div style="font-size: 24px; font-weight: bold; color: var(--success);">+ ${formatCurrency(totalSales)}</div>
                            </div>
                            <div>
                                <div style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">Total em Caixa</div>
                                <div style="font-size: 28px; font-weight: bold; color: var(--primary);">${formatCurrency(currentTotal)}</div>
                            </div>
                        </div>
                    </div>

                    <h3 style="margin: 20px 0;">Resumo por Forma de Pagamento</h3>
                    <div class="cards-grid" style="margin-bottom: 30px;">
                        ${Object.entries(paymentSummary).map(([method, amount]) => `
                            <div class="card">
                                <div class="card-title">${formatPaymentMethod(method)}</div>
                                <div class="card-value">${formatCurrency(amount)}</div>
                                <div class="card-label">${sales.filter(s => s.payment_method === method).length} transa√ß√µes</div>
                            </div>
                        `).join('')}
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-danger" onclick="closeCashier()">
                            <span>üîí</span> Fechar Caixa
                        </button>
                    </div>

                    <h3 style="margin: 30px 0 20px;">Movimenta√ß√µes do Dia</h3>
                    ${sales && sales.length > 0 ? `
                        <table>
                            <thead>
                                <tr>
                                    <th>Hor√°rio</th>
                                    <th>Valor</th>
                                    <th>Pagamento</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sales.map(sale => `
                                    <tr>
                                        <td>${formatDateTime(sale.created_at)}</td>
                                        <td><strong>${formatCurrency(sale.total)}</strong></td>
                                        <td><span class="badge badge-info">${formatPaymentMethod(sale.payment_method)}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : '<p style="text-align: center; color: #9ca3af;">Nenhuma movimenta√ß√£o registrada</p>'}
                `;

            } catch (error) {
                console.error('Erro ao carregar movimenta√ß√µes:', error);
                showAlert('Erro ao carregar movimenta√ß√µes: ' + formatError(error), 'danger');
            }
        }

        async function closeCashier() {
            if (!currentCashRegister) return;

            const finalAmount = prompt('Digite o valor final em caixa (R$):');
            if (finalAmount === null) return;

            const amount = parseFloat(finalAmount);
            if (isNaN(amount) || amount < 0) {
                showAlert('Valor inv√°lido', 'danger');
                return;
            }

            try {
                const { error } = await supabase
                    .from('cash_register')
                    .update({
                        closed_at: new Date().toISOString(),
                        final_amount: amount,
                        status: 'closed'
                    })
                    .eq('id', currentCashRegister.id);

                if (error) throw error;

                showAlert('Caixa fechado com sucesso!', 'success');
                currentCashRegister = null;
                await loadCashierStatus();

            } catch (error) {
                console.error('Erro ao fechar caixa:', error);
                showAlert('Erro ao fechar caixa: ' + formatError(error), 'danger');
            }
        }

        // Fun√ß√µes auxiliares
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR', { timeZone: 'America/Sao_Paulo' });
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' });
        }

        function formatPaymentMethod(method) {
            const methods = {
                'dinheiro': 'üíµ Dinheiro',
                'debito': 'üí≥ D√©bito',
                'credito': 'üí≥ Cr√©dito',
                'pix': 'üì± PIX'
            };
            return methods[method] || method;
        }

        function formatError(error) {
            console.error('Erro detalhado:', error);
            
            let message = 'Erro desconhecido';
            
            if (typeof error === 'string') {
                message = error;
            } else if (error.message) {
                message = error.message;
            } else if (error.error) {
                message = error.error;
            } else if (error.error_description) {
                message = error.error_description;
            }
            
            if (error.hint) {
                message += ` (${error.hint})`;
            }
            if (error.details) {
                message += ` - ${error.details}`;
            }
            
            return message;
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.minWidth = '300px';
            alertDiv.style.animation = 'slideInRight 0.3s';
            
            const icons = {
                success: '‚úì',
                danger: '‚úï',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };

            alertDiv.innerHTML = `
                <span>${icons[type]}</span>
                <span>${message}</span>
            `;

            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.style.animation = 'slideOutRight 0.3s';
                setTimeout(() => alertDiv.remove(), 300);
            }, 3000);
        }
    </script>

    <style>
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</body>
</html>
