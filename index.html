<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tamires Lima - Sistema de Vendas</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #7c3aed;
            --primary-dark: #6d28d9;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --neutral-50: #f9fafb;
            --neutral-100: #f3f4f6;
            --neutral-200: #e5e7eb;
            --neutral-300: #d1d5db;
            --neutral-400: #9ca3af;
            --neutral-500: #6b7280;
            --neutral-600: #4b5563;
            --neutral-700: #374151;
            --neutral-800: #1f2937;
            --neutral-900: #111827;
        }

        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-tertiary: #9ca3af;
            --border-color: #374151;
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #374151;
            --text-tertiary: #6b7280;
            --border-color: #e5e7eb;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Add mobile menu toggle */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            width: 40px;
            height: 40px;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            font-size: 24px;
            padding: 0;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
            flex-shrink: 0;
        }

        .sidebar-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .sidebar-subtitle {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .menu {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }

        .menu-item {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            color: var(--text-secondary);
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 500;
            text-align: left;
        }

        .menu-item:hover {
            background-color: var(--bg-tertiary);
            color: var(--primary);
        }

        .menu-item.active {
            background-color: var(--primary);
            color: white;
        }

        .menu-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .sidebar-footer {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .header-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: var(--border-color);
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .stat-content h3 {
            color: var(--text-tertiary);
            font-size: 11px;
            text-transform: uppercase;
            margin-bottom: 6px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
            word-break: break-word;
        }

        .stat-change {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .stat-icon {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            flex-shrink: 0;
        }

        .period-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .period-btn {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            flex: 1;
            min-width: 80px;
        }

        .period-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .chart-container {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            overflow-x: auto;
        }

        .table-container {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 500px;
        }

        th {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* Forms */
        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        input, textarea, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            background-color: var(--bg-primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--bg-primary);
            border-radius: 12px;
            padding: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
            gap: 12px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
            min-width: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        /* Image Upload */
        .image-upload {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background-color: var(--bg-tertiary);
        }

        .image-upload:hover {
            border-color: var(--primary);
            background-color: rgba(124, 58, 237, 0.05);
        }

        .image-upload.dragover {
            border-color: var(--primary);
            background-color: rgba(124, 58, 237, 0.1);
        }

        .image-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .image-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
            background-color: var(--bg-tertiary);
        }

        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background-color: var(--danger);
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        /* Theme Toggle */
        .theme-toggle {
            background: none;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s;
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .theme-toggle:hover {
            background-color: var(--border-color);
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Alerts */
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        .alert-success {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .alert-error {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .alert-info {
            background-color: rgba(124, 58, 237, 0.1);
            color: var(--primary);
            border: 1px solid rgba(124, 58, 237, 0.3);
        }

        .cart-sidebar {
            width: 100%;
            background-color: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 16px;
            gap: 12px;
        }

        .cart-item {
            background-color: var(--bg-tertiary);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .cart-total {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            padding: 12px;
            background-color: var(--bg-tertiary);
            border-radius: 8px;
            text-align: right;
        }

        .customer-search {
            position: relative;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            margin-top: 4px;
        }

        .search-result-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        .search-result-item:hover {
            background-color: var(--bg-tertiary);
        }

        /* SVG Icons */
        svg {
            width: 1em;
            height: 1em;
            fill: currentColor;
        }

        /* Mobile responsive styles */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                width: 280px;
                height: 100vh;
                z-index: 999;
                transform: translateX(-100%);
                border-right: 1px solid var(--border-color);
                border-bottom: none;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .mobile-menu-toggle {
                display: flex;
            }

            .main-content {
                width: 100%;
            }

            .header {
                padding: 12px 16px;
                gap: 8px;
            }

            .header-title {
                font-size: 18px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 13px;
            }

            .content {
                padding: 16px;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 12px;
                margin-bottom: 16px;
            }

            .stat-card {
                padding: 12px;
                flex-direction: column;
            }

            .stat-icon {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }

            .stat-value {
                font-size: 18px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .period-btn {
                padding: 6px 10px;
                font-size: 12px;
                min-width: 70px;
            }

            .chart-container {
                padding: 12px;
            }

            .table-container {
                border-radius: 8px;
            }

            th {
                padding: 8px;
                font-size: 11px;
            }

            td {
                padding: 8px;
                font-size: 13px;
            }

            .modal-content {
                padding: 16px;
                border-radius: 12px;
                max-width: 95vw;
            }

            .modal-header {
                margin-bottom: 16px;
                padding-bottom: 12px;
            }

            .modal-title {
                font-size: 16px;
            }

            .close-btn {
                width: 28px;
                height: 28px;
                font-size: 20px;
            }

            .image-preview {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }

            .cart-sidebar {
                width: 100%;
                border-top: 1px solid var(--border-color);
                border-left: none;
            }

            .header-actions {
                gap: 8px;
            }

            .btn-icon {
                width: 36px;
                height: 36px;
            }

            .theme-toggle {
                width: 36px;
                height: 36px;
            }
        }

        @media (max-width: 480px) {
            .header-title {
                font-size: 16px;
            }

            .btn {
                padding: 6px 10px;
                font-size: 12px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .stat-icon {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }

            .stat-value {
                font-size: 16px;
            }

            .content {
                padding: 12px;
            }

            .period-btn {
                padding: 6px 8px;
                font-size: 11px;
                min-width: 60px;
            }

            td {
                font-size: 12px;
                padding: 6px;
            }

            th {
                font-size: 10px;
                padding: 6px;
            }

            .chart-container {
                padding: 8px;
                margin-bottom: 12px;
            }

            .image-preview {
                grid-template-columns: repeat(2, 1fr);
            }

            .form-group {
                margin-bottom: 12px;
            }

            label {
                font-size: 13px;
                margin-bottom: 4px;
            }

            input, textarea, select {
                font-size: 16px;
                padding: 8px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">TL</div>
                <div>
                    <div class="sidebar-title">Tamires Lima</div>
                    <div class="sidebar-subtitle">Sistema de Vendas</div>
                </div>
            </div>

            <div class="menu">
                <button class="menu-item active" onclick="switchPage('dashboard')">
                    <span class="menu-icon">
                        <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
                    </span>
                    Dashboard
                </button>
                <button class="menu-item" onclick="switchPage('products')">
                    <span class="menu-icon">
                        <svg viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49A1.003 1.003 0 0 0 20 4H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>
                    </span>
                    Produtos
                </button>
                <button class="menu-item" onclick="switchPage('sales')">
                    <span class="menu-icon">
                        <svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>
                    </span>
                    Vendas
                </button>
                <button class="menu-item" onclick="switchPage('customers')">
                    <span class="menu-icon">
                        <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm8 7c0-2.67-4.04-4-8-4s-8 1.33-8 4v3h16v-3zM9 11c1.66 0 2.99-1.34 2.99-3S10.66 5 9 5C7.34 5 6 6.34 6 8s1.34 3 3 3zm0 7c2.67 0 8.04 1.33 8 4v3H1v-3c0-2.67 5.33-4 8-4z"/></svg>
                    </span>
                    Clientes
                </button>
                <button class="menu-item" onclick="switchPage('messages')">
                    <span class="menu-icon">
                        <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm13 7H6v-2h13v2zm0-4H6V9h13v3z"/></svg>
                    </span>
                    Mensagens
                </button>
                <button class="menu-item" onclick="switchPage('settings')">
                    <span class="menu-icon">
                        <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.64l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94L14.4 2.81c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41L9.25 5.35C8.66 5.59 8.12 5.92 7.63 6.29L5.24 5.33c-.22-.08-.47 0-.59.22L2.74 8.87c-.13.23-.07.5.12.64l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.64l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.5-.12-.64l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                    </span>
                    Configurações
                </button>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">
                    <svg viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                </button>
            </div>
        </div>

        <div class="main-content">
            <div class="header">
                <button class="mobile-menu-toggle" id="mobileMenuToggle" onclick="toggleSidebar()">
                    <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
                </button>
                <h1 class="header-title" id="pageTitle">Dashboard</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="logoutUser()" style="padding: 8px 12px;">Sair</button>
                </div>
            </div>

            <div class="content">
                <div id="dashboard" class="page active">
                    <div class="period-selector">
                        <button class="period-btn active" onclick="changePeriod('day')">Hoje</button>
                        <button class="period-btn" onclick="changePeriod('week')">Semana</button>
                        <button class="period-btn" onclick="changePeriod('month')">Mês</button>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-content">
                                <h3>Vendas</h3>
                                <div class="stat-value" id="totalSalesValue">R$ 0</div>
                                <div class="stat-change">+0 vs anterior</div>
                            </div>
                            <div class="stat-icon">
                                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-content">
                                <h3>Lucro</h3>
                                <div class="stat-value" id="totalProfitValue">R$ 0</div>
                                <div class="stat-change">Margem: <span id="profitMargin">0</span>%</div>
                            </div>
                            <div class="stat-icon">
                                <svg viewBox="0 0 24 24"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18 10 11.41l4 4 6.3-6.29L22 12v-6z"/></svg>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-content">
                                <h3>Transações</h3>
                                <div class="stat-value" id="totalTransactionsValue">0</div>
                                <div class="stat-change">Número de vendas</div>
                            </div>
                            <div class="stat-icon">
                                <svg viewBox="0 0 24 24"><path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/></svg>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-content">
                                <h3>Clientes</h3>
                                <div class="stat-value" id="totalCustomersValue">0</div>
                                <div class="stat-change">Cadastrados</div>
                            </div>
                            <div class="stat-icon">
                                <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 style="margin-bottom: 12px; font-size: 15px; font-weight: 600;">Últimas Transações</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Cliente</th>
                                        <th>Total</th>
                                        <th>Lucro</th>
                                        <th>Data</th>
                                    </tr>
                                </thead>
                                <tbody id="recentSalesTable">
                                    <tr>
                                        <td colspan="4" style="text-align: center; color: var(--text-tertiary);">Carregando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="products" class="page">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; gap: 12px; flex-wrap: wrap;">
                        <h2 style="font-size: 18px; font-weight: 600;">Produtos</h2>
                        <button class="btn btn-primary" onclick="openProductModal()">+ Novo</button>
                    </div>

                    <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                        <input type="text" id="productSearch" placeholder="Buscar..." onkeyup="filterProducts()" style="flex: 1; min-width: 150px;">
                        <select id="categoryFilter" onchange="filterProducts()" style="min-width: 140px;">
                            <option value="">Todas categorias</option>
                        </select>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Categoria</th>
                                    <th>Preço</th>
                                    <th>Custo</th>
                                    <th>Estoque</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="productsTable">
                                <tr>
                                    <td colspan="6" style="text-align: center; color: var(--text-tertiary);">Carregando...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="sales" class="page">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h2 style="font-size: 18px; font-weight: 600;">Nova Venda</h2>
                    </div>

                    <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label>Buscar Cliente</label>
                            <div class="customer-search">
                                <input type="text" id="customerSearch" placeholder="Nome ou telefone..." onkeyup="searchCustomers()">
                                <div class="search-results" id="searchResults"></div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button class="btn btn-secondary" onclick="openRegisterCustomerModal()">+ Cliente</button>
                        </div>
                    </div>

                    <div id="selectedCustomerInfo" style="background-color: var(--bg-secondary); border-radius: 8px; padding: 12px; margin-bottom: 16px; display: none;">
                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;" id="selectedCustomerName"></div>
                        <div style="font-size: 12px; color: var(--text-tertiary);" id="selectedCustomerPhone"></div>
                    </div>

                    <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                        <input type="text" id="productSearchSales" placeholder="Buscar produto..." style="flex: 1; min-width: 150px;">
                        <select id="categoryFilterSales" style="min-width: 140px;">
                            <option value="">Todas categorias</option>
                        </select>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr; gap: 16px; margin-bottom: 16px;">
                        <div>
                            <h3 style="font-size: 15px; font-weight: 600; margin-bottom: 12px;">Produtos</h3>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Produto</th>
                                            <th>Preço</th>
                                            <th>Estoque</th>
                                            <th>Ação</th>
                                        </tr>
                                    </thead>
                                    <tbody id="productsTableSales">
                                        <tr>
                                            <td colspan="4" style="text-align: center; color: var(--text-tertiary);">Carregando...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div style="background-color: var(--bg-secondary); border-radius: 12px; padding: 16px;">
                            <h3 style="font-size: 15px; font-weight: 600; margin-bottom: 12px;">Carrinho</h3>
                            <div id="cartItems" style="margin-bottom: 12px; max-height: 300px; overflow-y: auto;"></div>

                            <div class="cart-total">
                                <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 4px;">Total</div>
                                <div id="cartTotal" style="margin-bottom: 8px;">R$ 0</div>
                                <div style="font-size: 11px; color: var(--success);">Lucro: <span id="cartProfit">R$ 0</span></div>
                            </div>

                            <button class="btn btn-primary" onclick="completeSale()" style="width: 100%; margin-top: 12px;">Finalizar</button>
                            <button class="btn btn-secondary" onclick="clearCart()" style="width: 100%; margin-top: 8px;">Limpar</button>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 style="margin-bottom: 12px; font-size: 15px; font-weight: 600;">Histórico</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Cliente</th>
                                        <th>Total</th>
                                        <th>Lucro</th>
                                        <th>Data</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="salesHistoryTable">
                                    <tr>
                                        <td colspan="5" style="text-align: center; color: var(--text-tertiary);">Carregando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="customers" class="page">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; gap: 12px; flex-wrap: wrap;">
                        <h2 style="font-size: 18px; font-weight: 600;">Clientes</h2>
                        <button class="btn btn-primary" onclick="openRegisterCustomerModal()">+ Novo</button>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <input type="text" id="customerSearchMain" placeholder="Buscar cliente..." onkeyup="filterCustomers()">
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Telefone</th>
                                    <th>Aniversário</th>
                                    <th>Compras</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="customersTable">
                                <tr>
                                    <td colspan="5" style="text-align: center; color: var(--text-tertiary);">Carregando...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="messages" class="page">
                    <div style="margin-bottom: 16px;">
                        <h2 style="font-size: 18px; font-weight: 600;">Mensagens Pré-prontas</h2>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr; gap: 16px;">
                        <div>
                            <h3 style="font-size: 15px; font-weight: 600; margin-bottom: 12px;">Aniversários</h3>
                            <div id="birthdayMessages"></div>
                        </div>
                        <div>
                            <h3 style="font-size: 15px; font-weight: 600; margin-bottom: 12px;">Coleções Novas</h3>
                            <div id="newCollectionMessages"></div>
                        </div>
                    </div>

                    <div id="sendMessageModal" class="modal" style="display: none;">
                        <div class="modal-content" style="max-width: 500px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="font-size: 18px; font-weight: 600;">Enviar Mensagem</h3>
                                <button onclick="closeSendMessageModal()" style="background: none; border: none; cursor: pointer; font-size: 24px;">×</button>
                            </div>

                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px;">Selecione o Cliente</label>
                                <select id="messageCustomerSelect" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--bg-secondary); color: var(--text-primary); font-size: 14px;">
                                    <option value="">-- Selecione um cliente --</option>
                                </select>
                            </div>

                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px;">Selecione o Produto (opcional)</label>
                                <select id="messageProductSelect" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--bg-secondary); color: var(--text-primary); font-size: 14px;">
                                    <option value="">-- Sem produto --</option>
                                </select>
                            </div>

                            <div style="background-color: var(--bg-tertiary); padding: 12px; border-radius: 6px; margin-bottom: 16px; max-height: 200px; overflow-y: auto;">
                                <div style="font-size: 13px; line-height: 1.6;" id="messagePreviewText"></div>
                            </div>

                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button onclick="closeSendMessageModal()" class="btn" style="background-color: var(--bg-tertiary); color: var(--text-primary);">Cancelar</button>
                                <button onclick="confirmSendMessage()" class="btn btn-primary">Enviar via WhatsApp</button>
                            </div>
                        </div>
                    </div>

                </div>

                <div id="settings" class="page">
                    <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">Configurações</h2>

                    <div style="background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; max-width: 600px;">
                        <div class="form-group">
                            <label>Nome da Loja</label>
                            <input type="text" id="storeName" placeholder="Digite o nome">
                        </div>

                        <div class="form-group">
                            <label>Descrição</label>
                            <textarea id="storeDescription" placeholder="Descrição" rows="3"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Telefone WhatsApp</label>
                            <input type="tel" id="whatsappNumber" placeholder="(XX) 9XXXX-XXXX">
                        </div>

                        <div class="form-group">
                            <label>Logo (PNG, JPG)</label>
                            <div class="image-upload" onclick="document.getElementById('logoInput').click()">
                                <div style="font-size: 28px; margin-bottom: 8px;">
                                    <svg viewBox="0 0 24 24" style="width: 30px; height: 30px;"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                                </div>
                                <div style="font-size: 13px;">Clique ou arraste</div>
                                <input type="file" id="logoInput" accept="image/*" style="display: none;" onchange="uploadLogo(event)">
                            </div>
                            <div id="logoPreview" style="margin-top: 12px;"></div>
                        </div>

                        <div class="form-group">
                            <label>Favicon (PNG, ICO)</label>
                            <div class="image-upload" onclick="document.getElementById('faviconInput').click()">
                                <div style="font-size: 28px; margin-bottom: 8px;">
                                    <svg viewBox="0 0 24 24" style="width: 30px; height: 30px;"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                                </div>
                                <div style="font-size: 13px;">Clique ou arraste</div>
                                <input type="file" id="faviconInput" accept="image/*" style="display: none;" onchange="uploadFavicon(event)">
                            </div>
                            <div id="faviconPreview" style="margin-top: 12px;"></div>
                        </div>

                        <button class="btn btn-primary" onclick="saveStoreSettings()" style="width: 100%;">Salvar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Novo Produto</h2>
                <button class="close-btn" onclick="closeProductModal()">&times;</button>
            </div>

            <div class="form-group">
                <label>Nome</label>
                <input type="text" id="productName" placeholder="Digite o nome">
            </div>

            <div class="form-group">
                <label>Descrição</label>
                <textarea id="productDescription" placeholder="Descrição" rows="3"></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Categoria</label>
                    <input type="text" id="productCategory" placeholder="Ex: Camisetas">
                </div>
                <div class="form-group">
                    <label>Estoque</label>
                    <input type="number" id="productStock" placeholder="0" min="0">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Preço (R$)</label>
                    <input type="number" id="productPrice" placeholder="0.00" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Custo (R$)</label>
                    <input type="number" id="productCost" placeholder="0.00" min="0" step="0.01">
                </div>
            </div>

            <div class="form-group">
                <label>Imagens (até 3)</label>
                <div class="image-upload" id="imageUploadZone" onclick="document.getElementById('productImages').click()">
                    <div style="font-size: 28px; margin-bottom: 8px;">
                        <svg viewBox="0 0 24 24" style="width: 30px; height: 30px;"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                    </div>
                    <div style="font-size: 13px;">Clique ou arraste</div>
                    <input type="file" id="productImages" accept="image/*" multiple style="display: none;" onchange="handleImageUpload(event)">
                </div>
                <div class="image-preview" id="imagePreview"></div>
            </div>

            <button class="btn btn-primary" onclick="saveProduct()" style="width: 100%; margin-top: 16px;">Salvar</button>
        </div>
    </div>

    <div id="customerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Cadastrar Cliente</h2>
                <button class="close-btn" onclick="closeCustomerModal()">&times;</button>
            </div>

            <div class="form-group">
                <label>Nome</label>
                <input type="text" id="customerName" placeholder="Nome completo">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Telefone</label>
                    <input type="tel" id="customerPhone" placeholder="(XX) 9XXXX-XXXX">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="customerEmail" placeholder="email@example.com">
                </div>
            </div>

            <div class="form-group">
                <label>Aniversário</label>
                <input type="date" id="customerBirthDate">
            </div>

            <div class="form-group">
                <label>Endereço</label>
                <textarea id="customerAddress" placeholder="Rua, número, complemento" rows="2"></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Cidade</label>
                    <input type="text" id="customerCity" placeholder="Cidade">
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <input type="text" id="customerState" placeholder="UF">
                </div>
            </div>

            <button class="btn btn-primary" onclick="saveCustomer()" style="width: 100%; margin-top: 16px;">Salvar</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ulykbxvtclrpmikhrbeh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVseWtieHZ0Y2xycG1pa2hyYmVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyMTI4MzUsImV4cCI6MjA3Nzc4ODgzNX0.tixzhXBVtPy1S61mhlxAEK4uqcbFqTY7qIheBtAGRUY';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Application state
        let currentTheme = localStorage.getItem('theme') || 'light';
        let currentPeriod = 'day';
        let currentCart = [];
        let selectedCustomerId = null;
        let allProducts = [];
        let allCustomers = [];
        let allMessages = [];

        // NOVO: Armazena os objetos File para upload
        window.productFiles = []; 
        window.logoFile = null;
        window.faviconFile = null;

        let currentMessageToSend = {
            messageId: null,
            customerId: null,
            productId: null,
            messageType: null
        };

        document.addEventListener('DOMContentLoaded', async () => {
            setTheme(currentTheme);
            loadStoreSettings();
            loadDashboard();
            loadProducts();
            loadCustomers();
            loadMessages();
            loadCategories();
            closeSidebarOnMobile();
        });

        // --- INÍCIO: NOVAS FUNÇÕES DE UTILIDADE PARA STORAGE ---

        // Função para gerar um UUID (Necessário para dar nome único aos arquivos no Storage)
        function uuidv4() {
            return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }

        // Função centralizada para upload de arquivo
        async function uploadFileToSupabase(file, bucketName, filePath) {
            if (!file) return null;

            try {
                // 1. Upload do arquivo
                const { data, error: uploadError } = await supabase.storage
                    .from(bucketName)
                    .upload(filePath, file, {
                        cacheControl: '3600', // Cache por 1 hora
                        upsert: true         // Permite substituir se o nome do arquivo for o mesmo
                    });

                if (uploadError) throw uploadError;

                // 2. Obter URL pública
                const { data: publicUrlData } = supabase.storage
                    .from(bucketName)
                    .getPublicUrl(filePath);

                return publicUrlData.publicUrl;

            } catch (error) {
                console.error(`[Supabase Storage] Erro ao fazer upload em ${bucketName}/${filePath}:`, error.message);
                throw new Error(`Falha no upload: ${error.message}`);
            }
        }

        // --- FIM: NOVAS FUNÇÕES DE UTILIDADE PARA STORAGE ---


        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }

        function closeSidebarOnMobile() {
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').addEventListener('click', (e) => {
                    if (e.target.closest('.menu-item')) {
                        document.getElementById('sidebar').classList.remove('active');
                    }
                });
            }
        }

        // Theme management
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(currentTheme);
            localStorage.setItem('theme', currentTheme);
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const themeBtn = document.querySelector('.theme-toggle');
            if (themeBtn) {
                themeBtn.innerHTML = theme === 'light' ? '<svg viewBox="0 0 24 24"><path d="M12 17.25a5.25 5.25 0 1 0 0-10.5 5.25 5.25 0 0 0 0 10.5zM21 12a9 9 0 1 1-9-9 9 9 0 0 1 9 9z"/></svg>' : '<svg viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';
            }
        }

        // Page switching
        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');

            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.menu-item').classList.add('active');

            const titles = {
                dashboard: 'Dashboard',
                products: 'Produtos',
                sales: 'Vendas',
                customers: 'Clientes',
                messages: 'Mensagens',
                settings: 'Configurações'
            };
            document.getElementById('pageTitle').textContent = titles[pageId];

            if (pageId === 'dashboard') loadDashboard();
            if (pageId === 'products') loadProducts();
            if (pageId === 'sales') loadProductsForSales();
            if (pageId === 'customers') loadCustomers();
            if (pageId === 'messages') loadMessages();
        }

        async function loadDashboard() {
            try {
                const { data: sales, error } = await supabase
                    .from('sales')
                    .select('*')
                    .gte('created_at', getDateRange(currentPeriod).start);

                if (error) throw error;

                const totalSales = sales.reduce((sum, s) => sum + parseFloat(s.total_amount), 0);
                const totalProfit = sales.reduce((sum, s) => sum + parseFloat(s.total_profit), 0);
                const margin = totalSales > 0 ? ((totalProfit / totalSales) * 100).toFixed(1) : 0;

                document.getElementById('totalSalesValue').textContent = `R$ ${totalSales.toFixed(2)}`;
                document.getElementById('totalProfitValue').textContent = `R$ ${totalProfit.toFixed(2)}`;
                document.getElementById('profitMargin').textContent = margin;
                document.getElementById('totalTransactionsValue').textContent = sales.length;

                const { data: customers } = await supabase.from('customers').select('id');
                document.getElementById('totalCustomersValue').textContent = customers.length;

                const recentSales = sales.slice(-5).reverse();
                let html = '';
                for (const sale of recentSales) {
                    html += `
                        <tr>
                            <td>${sale.customer_name}</td>
                            <td>R$ ${parseFloat(sale.total_amount).toFixed(2)}</td>
                            <td style="color: var(--success);">R$ ${parseFloat(sale.total_profit).toFixed(2)}</td>
                            <td>${new Date(sale.created_at).toLocaleDateString('pt-BR')}</td>
                        </tr>
                    `;
                }
                document.getElementById('recentSalesTable').innerHTML = html || '<tr><td colspan="4" style="text-align: center; color: var(--text-tertiary);">Nenhuma venda</td></tr>';
            } catch (error) {
                console.log('[v0] Dashboard error:', error.message);
            }
        }

        function getDateRange(period) {
            const now = new Date();
            let start = new Date();

            if (period === 'day') {
                start.setHours(0, 0, 0, 0);
            } else if (period === 'week') {
                start.setDate(now.getDate() - now.getDay());
                start.setHours(0, 0, 0, 0);
            } else if (period === 'month') {
                start.setDate(1);
                start.setHours(0, 0, 0, 0);
            }

            return { start: start.toISOString(), end: now.toISOString() };
        }

        function changePeriod(period) {
            currentPeriod = period;
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            loadDashboard();
        }

        async function loadProducts() {
            try {
                const { data, error } = await supabase
                    .from('products')
                    .select('*')
                    .eq('active', true);

                if (error) throw error;

                allProducts = data || [];
                displayProducts();
            } catch (error) {
                console.log('[v0] Load products error:', error.message);
            }
        }

        function displayProducts() {
            let html = '';
            for (const product of allProducts) {
                html += `
                    <tr>
                        <td>${product.name}</td>
                        <td>${product.category}</td>
                        <td>R$ ${parseFloat(product.price).toFixed(2)}</td>
                        <td>R$ ${parseFloat(product.cost).toFixed(2)}</td>
                        <td>${product.stock_quantity}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="editProduct('${product.id}')">Edit</button>
                            <button class="btn" style="padding: 4px 8px; font-size: 12px; background-color: var(--danger); color: white;" onclick="deleteProduct('${product.id}')">Del</button>
                        </td>
                    </tr>
                `;
            }
            document.getElementById('productsTable').innerHTML = html || '<tr><td colspan="6" style="text-align: center; color: var(--text-tertiary);">Sem produtos</td></tr>';
        }

        function filterProducts() {
            const search = document.getElementById('productSearch').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;

            const filtered = allProducts.filter(p => 
                (p.name.toLowerCase().includes(search)) &&
                (category === '' || p.category === category)
            );

            let html = '';
            for (const product of filtered) {
                html += `
                    <tr>
                        <td>${product.name}</td>
                        <td>${product.category}</td>
                        <td>R$ ${parseFloat(product.price).toFixed(2)}</td>
                        <td>R$ ${parseFloat(product.cost).toFixed(2)}</td>
                        <td>${product.stock_quantity}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="editProduct('${product.id}')">Edit</button>
                            <button class="btn" style="padding: 4px 8px; font-size: 12px; background-color: var(--danger); color: white;" onclick="deleteProduct('${product.id}')">Del</button>
                        </td>
                    </tr>
                `;
            }
            document.getElementById('productsTable').innerHTML = html || '<tr><td colspan="6" style="text-align: center; color: var(--text-tertiary);">Nenhum encontrado</td></tr>';
        }

        function openProductModal() {
            document.getElementById('productModal').classList.add('active');
            document.getElementById('productName').value = '';
            document.getElementById('productDescription').value = '';
            document.getElementById('productCategory').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productCost').value = '';
            document.getElementById('productStock').value = '';
            document.getElementById('imagePreview').innerHTML = '';
            // Limpa o estado global dos arquivos
            window.productFiles = []; 
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
        }

        // --- FUNÇÕES DE IMAGEM ATUALIZADAS PARA USAR O OBJETO FILE ---

        function handleImageUpload(event) {
            const files = Array.from(event.target.files).slice(0, 3);
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            window.productFiles = []; // Zera os arquivos para o novo upload

            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'image-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button class="image-remove" onclick="removeProductImage(${index})">×</button>
                    `;
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file); // Apenas para pré-visualização (Base64)
                
                window.productFiles.push(file); // Armazena o objeto File para o upload real
            });
        }

        function removeProductImage(index) {
            if (window.productFiles && index >= 0 && index < window.productFiles.length) {
                window.productFiles.splice(index, 1);
            }
            // Re-renderiza a pré-visualização para refletir a remoção
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = ''; 
            window.productFiles.forEach((file, idx) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'image-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button class="image-remove" onclick="removeProductImage(${idx})">×</button>
                    `;
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        // --- FUNÇÃO SAVE PRODUCT ATUALIZADA PARA USAR O UPLOAD DE IMAGENS ---

        async function saveProduct() {
            const name = document.getElementById('productName').value.trim();
            const description = document.getElementById('productDescription').value.trim();
            const category = document.getElementById('productCategory').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value);
            const cost = parseFloat(document.getElementById('productCost').value);
            const stock = parseInt(document.getElementById('productStock').value) || 0;
            const files = window.productFiles || [];

            if (!name || !category || !price || !cost) {
                alert('Preencha todos os campos obrigatórios');
                return;
            }

            try {
                const product_id = uuidv4(); // ID único para a linha da tabela e para o caminho no Storage
                const uploadedUrls = [];

                // 1. Upload das imagens para o Supabase Storage
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    // Gera o caminho: products/id_produto/1.ext
                    const fileExtension = file.name.split('.').pop();
                    const filePath = `products/${product_id}/${i + 1}.${fileExtension}`; 

                    const url = await uploadFileToSupabase(file, 'products', filePath); // Usa o bucket 'products'
                    if (url) {
                        uploadedUrls.push(url);
                    }
                }

                // 2. Inserção do produto no banco de dados com as URLs
                const { data, error } = await supabase
                    .from('products')
                    .insert([{
                        id: product_id, // Insere o ID gerado
                        name,
                        description,
                        category,
                        price,
                        cost,
                        stock_quantity: stock,
                        image_url_1: uploadedUrls[0] || null,
                        image_url_2: uploadedUrls[1] || null,
                        image_url_3: uploadedUrls[2] || null
                    }])
                    .select();

                if (error) throw error;

                alert('Produto salvo e imagens enviadas!');
                closeProductModal();
                loadProducts();
                loadCategories();
                window.productFiles = []; // Limpa o estado após o upload
            } catch (error) {
                alert('Erro ao salvar produto ou fazer upload da imagem: ' + error.message);
            }
        }

        async function deleteProduct(id) {
            if (!confirm('Tem certeza?')) return;

            try {
                const { error } = await supabase
                    .from('products')
                    .update({ active: false })
                    .eq('id', id);

                if (error) throw error;

                alert('Removido!');
                loadProducts();
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }

        async function loadCategories() {
            try {
                const { data } = await supabase
                    .from('products')
                    .select('category')
                    .eq('active', true);

                const categories = [...new Set(data.map(p => p.category))];
                
                ['categoryFilter', 'categoryFilterSales'].forEach(id => {
                    const select = document.getElementById(id);
                    if (select) {
                        const currentValue = select.value;
                        select.innerHTML = '<option value="">Todas categorias</option>';
                        categories.forEach(cat => {
                            select.innerHTML += `<option value="${cat}">${cat}</option>`;
                        });
                        select.value = currentValue;
                    }
                });
            } catch (error) {
                console.log('[v0] Load categories error:', error.message);
            }
        }

        async function loadCustomers() {
            try {
                const { data, error } = await supabase
                    .from('customers')
                    .select('*')
                    .eq('active', true);

                if (error) throw error;

                allCustomers = data || [];
                displayCustomers();
            } catch (error) {
                console.log('[v0] Load customers error:', error.message);
            }
        }

        function displayCustomers() {
            let html = '';
            for (const customer of allCustomers) {
                const birthDate = customer.birth_date ? new Date(customer.birth_date).toLocaleDateString('pt-BR') : '-';
                html += `
                    <tr>
                        <td>${customer.name}</td>
                        <td>${customer.phone}</td>
                        <td>${birthDate}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="viewCustomerHistory('${customer.id}')">Ver</button>
                        </td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="editCustomer('${customer.id}')">Edit</button>
                        </td>
                    </tr>
                `;
            }
            document.getElementById('customersTable').innerHTML = html || '<tr><td colspan="5" style="text-align: center; color: var(--text-tertiary);">Sem clientes</td></tr>';
        }

        function filterCustomers() {
            const search = document.getElementById('customerSearchMain').value.toLowerCase();
            const filtered = allCustomers.filter(c =>
                c.name.toLowerCase().includes(search) || c.phone.includes(search)
            );

            let html = '';
            for (const customer of filtered) {
                const birthDate = customer.birth_date ? new Date(customer.birth_date).toLocaleDateString('pt-BR') : '-';
                html += `
                    <tr>
                        <td>${customer.name}</td>
                        <td>${customer.phone}</td>
                        <td>${birthDate}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="viewCustomerHistory('${customer.id}')">Ver</button>
                        </td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="editCustomer('${customer.id}')">Edit</button>
                        </td>
                    </tr>
                `;
            }
            document.getElementById('customersTable').innerHTML = html || '<tr><td colspan="5" style="text-align: center; color: var(--text-tertiary);">Nenhum encontrado</td></tr>';
        }

        function openRegisterCustomerModal() {
            document.getElementById('customerModal').classList.add('active');
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerBirthDate').value = '';
            document.getElementById('customerAddress').value = '';
            document.getElementById('customerCity').value = '';
            document.getElementById('customerState').value = '';
        }

        function closeCustomerModal() {
            document.getElementById('customerModal').classList.remove('active');
        }

        async function saveCustomer() {
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            const birthDate = document.getElementById('customerBirthDate').value;
            const address = document.getElementById('customerAddress').value.trim();
            const city = document.getElementById('customerCity').value.trim();
            const state = document.getElementById('customerState').value.trim();

            if (!name || !phone) {
                alert('Nome e telefone são obrigatórios');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('customers')
                    .insert([{
                        name,
                        phone,
                        email: email || null,
                        birth_date: birthDate || null,
                        address,
                        city,
                        state
                    }])
                    .select();

                if (error) throw error;

                selectedCustomerId = data[0].id;
                document.getElementById('selectedCustomerInfo').style.display = 'block';
                document.getElementById('selectedCustomerName').textContent = name;
                document.getElementById('selectedCustomerPhone').textContent = phone;

                alert('Cliente cadastrado!');
                closeCustomerModal();
                loadCustomers();
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }

        async function viewCustomerHistory(customerId) {
            try {
                const { data, error } = await supabase
                    .from('sales')
                    .select('*')
                    .eq('customer_id', customerId);

                if (error) throw error;

                const customer = allCustomers.find(c => c.id === customerId);
                const totalSpent = data.reduce((sum, s) => sum + parseFloat(s.total_amount), 0);

                alert(`${customer.name}\n\nCompras: ${data.length}\nTotal: R$ ${totalSpent.toFixed(2)}`);
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }

        async function loadProductsForSales() {
            await loadProducts();
            displayProductsForSales();
        }

        function displayProductsForSales() {
            let html = '';
            for (const product of allProducts) {
                html += `
                    <tr>
                        <td>${product.name}</td>
                        <td>R$ ${parseFloat(product.price).toFixed(2)}</td>
                        <td>${product.stock_quantity}</td>
                        <td>
                            <input type="number" id="qty_${product.id}" min="1" value="1" max="${product.stock_quantity}" style="width: 50px; padding: 4px;">
                            <button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;" onclick="addToCart('${product.id}')">+</button>
                        </td>
                    </tr>
                `;
            }
            document.getElementById('productsTableSales').innerHTML = html;
        }

        function addToCart(productId) {
            const product = allProducts.find(p => p.id === productId);
            const qty = parseInt(document.getElementById(`qty_${productId}`).value);

            if (qty > product.stock_quantity) {
                alert('Estoque insuficiente');
                return;
            }

            const existingItem = currentCart.find(item => item.id === productId);
            if (existingItem) {
                existingItem.quantity += qty;
            } else {
                currentCart.push({
                    id: productId,
                    name: product.name,
                    price: product.price,
                    cost: product.cost,
                    quantity: qty
                });
            }

            updateCartDisplay();
        }

        function updateCartDisplay() {
            let html = '';
            let total = 0;
            let totalCost = 0;

            for (const item of currentCart) {
                const subtotal = item.price * item.quantity;
                const subtotalCost = item.cost * item.quantity;
                total += subtotal;
                totalCost += subtotalCost;

                html += `
                    <div class="cart-item">
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; font-size: 13px; overflow: hidden; text-overflow: ellipsis;">${item.name}</div>
                            <div style="font-size: 11px; color: var(--text-tertiary);">Qtd: ${item.quantity}</div>
                        </div>
                        <div style="display: flex; gap: 6px; flex-shrink: 0;">
                            <button class="btn btn-secondary" style="padding: 3px 6px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px;" onclick="removeFromCart('${item.id}')">−</button>
                            <button class="btn" style="padding: 3px 6px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background-color: var(--danger); color: white; font-size: 11px;" onclick="removeItemFromCart('${item.id}')">×</button>
                        </div>
                    </div>
                `;
            }

            document.getElementById('cartItems').innerHTML = html;
            document.getElementById('cartTotal').textContent = `R$ ${total.toFixed(2)}`;
            document.getElementById('cartProfit').textContent = `R$ ${(total - totalCost).toFixed(2)}`;
        }

        function removeFromCart(productId) {
            const item = currentCart.find(i => i.id === productId);
            if (item.quantity > 1) {
                item.quantity--;
            } else {
                currentCart = currentCart.filter(i => i.id !== productId);
            }
            updateCartDisplay();
        }

        function removeItemFromCart(productId) {
            currentCart = currentCart.filter(i => i.id !== productId);
            updateCartDisplay();
        }

        function clearCart() {
            currentCart = [];
            updateCartDisplay();
            selectedCustomerId = null;
            document.getElementById('selectedCustomerInfo').style.display = 'none';
        }

        async function completeSale() {
            if (currentCart.length === 0) {
                alert('Carrinho vazio');
                return;
            }

            if (!selectedCustomerId) {
                alert('Selecione um cliente');
                return;
            }

            try {
                let totalAmount = 0;
                let totalCost = 0;

                for (const item of currentCart) {
                    totalAmount += item.price * item.quantity;
                    totalCost += item.cost * item.quantity;
                }

                const totalProfit = totalAmount - totalCost;
                const customer = allCustomers.find(c => c.id === selectedCustomerId);

                const { data: sale, error: saleError } = await supabase
                    .from('sales')
                    .insert([{
                        customer_id: selectedCustomerId,
                        customer_name: customer.name,
                        total_amount: totalAmount,
                        total_cost: totalCost,
                        total_profit: totalProfit
                    }])
                    .select();

                if (saleError) throw saleError;

                for (const item of currentCart) {
                    const itemProfit = (item.price - item.cost) * item.quantity;
                    await supabase
                        .from('sale_items')
                        .insert([{
                            sale_id: sale[0].id,
                            product_id: item.id,
                            product_name: item.name,
                            quantity: item.quantity,
                            unit_price: item.price,
                            unit_cost: item.cost,
                            subtotal: item.price * item.quantity,
                            profit: itemProfit
                        }]);

                    const product = allProducts.find(p => p.id === item.id);
                    await supabase
                        .from('products')
                        .update({ stock_quantity: product.stock_quantity - item.quantity })
                        .eq('id', item.id);
                }

                alert('Venda realizada!');
                clearCart();
                loadProductsForSales();
                loadDashboard();
            } catch (error) {
                alert('Erro: ' + error.message);
            }
        }

        function searchCustomers() {
            const search = document.getElementById('customerSearch').value.toLowerCase();
            const results = document.getElementById('searchResults');

            if (search.length === 0) {
                results.innerHTML = '';
                return;
            }

            const filtered = allCustomers.filter(c =>
                c.name.toLowerCase().includes(search) || c.phone.includes(search)
            );

            let html = '';
            for (const customer of filtered) {
                html += `
                    <div class="search-result-item" onclick="selectCustomer('${customer.id}', '${customer.name}', '${customer.phone}')">
                        <div style="font-weight: 600; font-size: 13px;">${customer.name}</div>
                        <div style="font-size: 11px; color: var(--text-tertiary);">${customer.phone}</div>
                    </div>
                `;
            }

            results.innerHTML = html;
        }

        function selectCustomer(customerId, name, phone) {
            selectedCustomerId = customerId;
            document.getElementById('customerSearch').value = name;
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('selectedCustomerInfo').style.display = 'block';
            document.getElementById('selectedCustomerName').textContent = name;
            document.getElementById('selectedCustomerPhone').textContent = phone;
        }

        async function loadMessages() {
            try {
                const { data, error } = await supabase
                    .from('pre_made_messages')
                    .select('*')
                    .eq('active', true);

                if (error) throw error;

                allMessages = data || [];
                displayMessages();
            } catch (error) {
                console.log('[v0] Load messages error:', error.message);
            }
        }

        function displayMessages() {
            const birthdays = allMessages.filter(m => m.type === 'birthday');
            const collections = allMessages.filter(m => m.type === 'new_collection');

            let birthdayHtml = '';
            for (const msg of birthdays) {
                birthdayHtml += `
                    <div style="background-color: var(--bg-tertiary); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                        <div style="font-weight: 600; margin-bottom: 8px; font-size: 14px;">${msg.title}</div>
                        <div style="font-size: 13px; margin-bottom: 12px; line-height: 1.5;">${msg.content}</div>
                        <button class="btn btn-primary" style="width: 100%; font-size: 12px;" onclick="openSendMessageModal('${msg.id}', 'birthday')">Enviar</button>
                    </div>
                `;
            }

            let collectionHtml = '';
            for (const msg of collections) {
                collectionHtml += `
                    <div style="background-color: var(--bg-tertiary); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                        <div style="font-weight: 600; margin-bottom: 8px; font-size: 14px;">${msg.title}</div>
                        <div style="font-size: 13px; margin-bottom: 12px; line-height: 1.5;">${msg.content}</div>
                        <button class="btn btn-primary" style="width: 100%; font-size: 12px;" onclick="openSendMessageModal('${msg.id}', 'new_collection')">Enviar</button>
                    </div>
                `;
            }

            document.getElementById('birthdayMessages').innerHTML = birthdayHtml || '<div style="color: var(--text-tertiary); font-size: 13px;">Nenhuma</div>';
            document.getElementById('newCollectionMessages').innerHTML = collectionHtml || '<div style="color: var(--text-tertiary); font-size: 13px;">Nenhuma</div>';
        }

        function openSendMessageModal(messageId, messageType) {
            currentMessageToSend.messageId = messageId;
            currentMessageToSend.messageType = messageType;
            currentMessageToSend.customerId = null;
            currentMessageToSend.productId = null;

            // Preencher select de clientes
            const customerSelect = document.getElementById('messageCustomerSelect');
            customerSelect.innerHTML = '<option value="">-- Selecione um cliente --</option>';
            for (const customer of allCustomers) {
                customerSelect.innerHTML += `<option value="${customer.id}">${customer.name} - ${customer.phone}</option>`;
            }

            // Preencher select de produtos
            const productSelect = document.getElementById('messageProductSelect');
            productSelect.innerHTML = '<option value="">-- Sem produto --</option>';
            for (const product of allProducts) {
                productSelect.innerHTML += `<option value="${product.id}">${product.name} - R$ ${product.price.toFixed(2)}</option>`;
            }

            updateMessagePreview();
            document.getElementById('sendMessageModal').style.display = 'flex';
        }

        function closeSendMessageModal() {
            document.getElementById('sendMessageModal').style.display = 'none';
            currentMessageToSend = { messageId: null, customerId: null, productId: null, messageType: null };
        }

        function updateMessagePreview() {
            const message = allMessages.find(m => m.id === currentMessageToSend.messageId);
            if (!message) return;

            let previewText = message.content;

            // Substituir placeholders com base na seleção
            if (currentMessageToSend.customerId) {
                const customer = allCustomers.find(c => c.id === currentMessageToSend.customerId);
                if (customer) {
                    previewText = previewText.replace('[Nome do Cliente]', customer.name);
                }
            } else {
                 previewText = previewText.replace('[Nome do Cliente]', 'Cliente');
            }

            if (currentMessageToSend.productId) {
                const product = allProducts.find(p => p.id === currentMessageToSend.productId);
                if (product) {
                    let productDetails = `\n\n📦 Produto: ${product.name}\n💰 Preço: R$ ${product.price.toFixed(2)}`;
                    if (product.image_url_1) {
                        productDetails += `\n🔗 Ver produto: ${window.location.origin}?product=${product.id}`;
                    }
                    previewText = previewText.replace('[Lista de Produtos]', productDetails);
                }
            } else {
                 previewText = previewText.replace('[Lista de Produtos]', '');
            }

            document.getElementById('messagePreviewText').textContent = previewText;
        }

        // Adicionar event listeners aos selects para atualizar o preview dinamicamente
        document.addEventListener('DOMContentLoaded', function() {
            const customerSelect = document.getElementById('messageCustomerSelect');
            const productSelect = document.getElementById('messageProductSelect');

            if (customerSelect) {
                customerSelect.addEventListener('change', function() {
                    currentMessageToSend.customerId = this.value;
                    updateMessagePreview();
                });
            }

            if (productSelect) {
                productSelect.addEventListener('change', function() {
                    currentMessageToSend.productId = this.value;
                    updateMessagePreview();
                });
            }
        });


        async function confirmSendMessage() {
            const { messageId, customerId, productId, messageType } = currentMessageToSend;

            if (!customerId) {
                alert('Selecione um cliente');
                return;
            }

            const message = allMessages.find(m => m.id === messageId);
            const customer = allCustomers.find(c => c.id === customerId);

            if (!message || !customer) {
                alert('Erro: Cliente ou mensagem não encontrado');
                return;
            }

            try {
                let messageText = message.content;
                let productLink = null;

                // Substituir placeholders
                messageText = messageText.replace('[Nome do Cliente]', customer.name);

                if (productId) {
                    const product = allProducts.find(p => p.id === productId);
                    if (product) {
                        productLink = `${window.location.origin}?product=${product.id}`;
                        messageText += `\n\n📦 Produto: ${product.name}\n💰 Preço: R$ ${product.price.toFixed(2)}\n🔗 Ver produto: ${productLink}`;
                    }
                } else {
                    messageText = messageText.replace('[Lista de Produtos]', ''); // Remove placeholder if no product
                }


                const whatsappPhone = customer.phone.replace(/\D/g, '');
                const whatsappLink = `https://wa.me/${whatsappPhone}?text=${encodeURIComponent(messageText)}`;

                // Salvar histórico
                await supabase
                    .from('message_history')
                    .insert([{
                        customer_id: customerId,
                        message_template_id: messageId,
                        product_id: productId || null,
                        message_type: messageType,
                        message_content: messageText,
                        whatsapp_link: whatsappLink,
                        sent_at: new Date().toISOString(),
                        status: 'pending' // Or 'sent' if we can confirm delivery
                    }]);

                // Abrir WhatsApp
                window.open(whatsappLink, '_blank');

                closeSendMessageModal();
                alert('Mensagem preparada! WhatsApp será aberto para envio.');
            } catch (error) {
                console.log('[v0] Error sending message:', error.message);
                alert('Erro ao enviar: ' + error.message);
            }
        }

        // These functions seem to be remnants or not directly used in the current flow.
        // Kept for potential future use or if they were intended for other actions.
        async function sendBirthdayMessages(messageId) {
            console.log('sendBirthdayMessages called with id:', messageId);
            // Implement logic to find birthday customers and send messages if needed
        }

        async function sendCollectionMessage(messageId) {
            console.log('sendCollectionMessage called with id:', messageId);
            // Implement logic to find relevant customers and send collection messages if needed
        }


        async function loadStoreSettings() {
            try {
                const { data, error } = await supabase
                    .from('store_config')
                    .select('*')
                    .limit(1)
                    .single();

                if (error && error.code !== 'PGRST116') throw error; // Ignore 'Not found' error

                if (data) {
                    document.getElementById('storeName').value = data.store_name || 'Tamires Lima';
                    document.getElementById('storeDescription').value = data.store_description || '';
                    document.getElementById('whatsappNumber').value = data.whatsapp_number || '';
                    
                    if (data.logo_url) {
                        document.getElementById('logoPreview').innerHTML = `<img src="${data.logo_url}" style="max-width: 100px; border-radius: 8px;">`;
                    }
                    
                    if (data.favicon_url) {
                        document.getElementById('faviconPreview').innerHTML = `<img src="${data.favicon_url}" style="max-width: 50px; border-radius: 8px;">`;
                    }
                } else {
                    // Create default config if none exists
                    await supabase
                        .from('store_config')
                        .insert([{ store_name: 'Tamires Lima' }]);
                }
            } catch (error) {
                console.log('[v0] Load settings error:', error.message);
            }
        }

        // --- FUNÇÕES DE LOGO/FAVICON ATUALIZADAS PARA USAR O OBJETO FILE ---

        async function uploadLogo(event) {
            const file = event.target.files[0];
            if (!file) return;

            window.logoFile = file; // Armazena o objeto File
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('logoPreview').innerHTML = `<img src="${e.target.result}" style="max-width: 100px; border-radius: 8px;">`;
            };
            reader.readAsDataURL(file); // Apenas para pré-visualização
        }

        async function uploadFavicon(event) {
            const file = event.target.files[0];
            if (!file) return;

            window.faviconFile = file; // Armazena o objeto File
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('faviconPreview').innerHTML = `<img src="${e.target.result}" style="max-width: 50px; border-radius: 8px;">`;
            };
            reader.readAsDataURL(file); // Apenas para pré-visualização
        }

        // --- FUNÇÃO SAVE STORE SETTINGS ATUALIZADA PARA USAR O UPLOAD DE IMAGENS ---

        async function saveStoreSettings() {
            const name = document.getElementById('storeName').value.trim();
            const description = document.getElementById('storeDescription').value.trim();
            const whatsapp = document.getElementById('whatsappNumber').value.trim();

            try {
                // 1. Obter config ID existente
                const { data: configData, error: getConfigError } = await supabase
                    .from('store_config')
                    .select('id, logo_url, favicon_url')
                    .limit(1)
                    .single();
                
                if (getConfigError && getConfigError.code !== 'PGRST116') throw getConfigError;

                const configId = configData ? configData.id : null;
                let logoUrl = configData?.logo_url || null;
                let faviconUrl = configData?.favicon_url || null;

                // 2. Upload da Logo se um novo arquivo foi selecionado
                if (window.logoFile) {
                    const fileExtension = window.logoFile.name.split('.').pop();
                    const filePath = `store/logo.${fileExtension}`; 
                    logoUrl = await uploadFileToSupabase(window.logoFile, 'store', filePath); // Usa o bucket 'store'
                    window.logoFile = null; // Limpa o estado
                }

                // 3. Upload do Favicon se um novo arquivo foi selecionado
                if (window.faviconFile) {
                    const fileExtension = window.faviconFile.name.split('.').pop();
                    const filePath = `store/favicon.${fileExtension}`;
                    faviconUrl = await uploadFileToSupabase(window.faviconFile, 'store', filePath); // Usa o bucket 'store'
                    window.faviconFile = null; // Limpa o estado
                }

                const updateData = {
                    store_name: name,
                    store_description: description,
                    whatsapp_number: whatsapp,
                    logo_url: logoUrl,
                    favicon_url: faviconUrl
                };

                // 4. Salvar/Atualizar no banco de dados
                if (configId) {
                    // Update existing config
                    const { error } = await supabase
                        .from('store_config')
                        .update(updateData)
                        .eq('id', configId);
                    if (error) throw error;
                } else {
                    // Insert new config
                    const { error } = await supabase
                        .from('store_config')
                        .insert([updateData]);
                    if (error) throw error;
                }

                alert('Configurações salvas e imagens enviadas!');
                loadStoreSettings(); // Recarrega para mostrar as novas URLs
            } catch (error) {
                alert('Erro ao salvar configurações ou fazer upload da imagem: ' + error.message);
            }
        }

        function logoutUser() {
            // Implement actual logout if authentication is added
            alert('Logout realizado');
        }
    </script>
</body>
</html>
