<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tamires Lima - Sistema de Vendas</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #7c3aed;
            --primary-dark: #6d28d9;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --neutral-50: #f9fafb;
            --neutral-100: #f3f4f6;
            --neutral-200: #e5e7eb;
            --neutral-300: #d1d5db;
            --neutral-400: #9ca3af;
            --neutral-500: #6b7280;
            --neutral-600: #4b5563;
            --neutral-700: #374151;
            --neutral-800: #1f2937;
            --neutral-900: #111827;
        }

        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-tertiary: #9ca3af;
            --border-color: #374151;
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #374151;
            --text-tertiary: #6b7280;
            --border-color: #e5e7eb;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }

        .sidebar-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .sidebar-subtitle {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .menu {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }

        .menu-item {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            color: var(--text-secondary);
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 500;
        }

        .menu-item:hover {
            background-color: var(--bg-tertiary);
            color: var(--primary);
        }

        .menu-item.active {
            background-color: var(--primary);
            color: white;
        }

        .menu-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-footer {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: var(--border-color);
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .stat-content h3 {
            color: var(--text-tertiary);
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .stat-change {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .period-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .period-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .period-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .chart-container {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .table-container {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 12px 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-color);
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* Forms */
        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        input, textarea, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            background-color: var(--bg-primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--bg-primary);
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Image Upload */
        .image-upload {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background-color: var(--bg-tertiary);
        }

        .image-upload:hover {
            border-color: var(--primary);
            background-color: rgba(124, 58, 237, 0.05);
        }

        .image-upload.dragover {
            border-color: var(--primary);
            background-color: rgba(124, 58, 237, 0.1);
        }

        .image-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .image-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
            background-color: var(--bg-tertiary);
        }

        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background-color: var(--danger);
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        /* Theme Toggle */
        .theme-toggle {
            background: none;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s;
            background-color: var(--bg-tertiary);
        }

        .theme-toggle:hover {
            background-color: var(--border-color);
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Alerts */
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        .alert-success {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .alert-error {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .alert-info {
            background-color: rgba(124, 58, 237, 0.1);
            color: var(--primary);
            border: 1px solid rgba(124, 58, 237, 0.3);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .cart-sidebar {
            width: 350px;
            background-color: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .cart-item {
            background-color: var(--bg-tertiary);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-total {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            padding: 12px;
            background-color: var(--bg-tertiary);
            border-radius: 8px;
            text-align: right;
        }

        .customer-search {
            position: relative;
            margin-bottom: 16px;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
        }

        .search-result-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        .search-result-item:hover {
            background-color: var(--bg-tertiary);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">TL</div>
                <div>
                    <div class="sidebar-title">Tamires Lima</div>
                    <div class="sidebar-subtitle">Sistema de Vendas</div>
                </div>
            </div>

            <div class="menu">
                <button class="menu-item active" onclick="switchPage('dashboard')">
                    <span class="menu-icon">üìä</span>
                    Dashboard
                </button>
                <button class="menu-item" onclick="switchPage('products')">
                    <span class="menu-icon">üì¶</span>
                    Produtos
                </button>
                <button class="menu-item" onclick="switchPage('sales')">
                    <span class="menu-icon">üõçÔ∏è</span>
                    Vendas
                </button>
                <button class="menu-item" onclick="switchPage('customers')">
                    <span class="menu-icon">üë•</span>
                    Clientes
                </button>
                <button class="menu-item" onclick="switchPage('messages')">
                    <span class="menu-icon">üí¨</span>
                    Mensagens
                </button>
                <button class="menu-item" onclick="switchPage('settings')">
                    <span class="menu-icon">‚öôÔ∏è</span>
                    Configura√ß√µes
                </button>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1 class="header-title" id="pageTitle">Dashboard</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="logoutUser()">Sair</button>
                </div>
            </div>

            <div class="content">
                <!-- Dashboard Page -->
                <div id="dashboard" class="page active">
                    <div class="period-selector">
                        <button class="period-btn active" onclick="changePeriod('day')">Hoje</button>
                        <button class="period-btn" onclick="changePeriod('week')">Esta Semana</button>
                        <button class="period-btn" onclick="changePeriod('month')">Este M√™s</button>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-content">
                                <h3>Vendas</h3>
                                <div class="stat-value" id="totalSalesValue">R$ 0</div>
                                <div class="stat-change">+0 comparado ao per√≠odo anterior</div>
                            </div>
                            <div class="stat-icon">üí∞</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-content">
                                <h3>Lucro</h3>
                                <div class="stat-value" id="totalProfitValue">R$ 0</div>
                                <div class="stat-change">Margem: <span id="profitMargin">0</span>%</div>
                            </div>
                            <div class="stat-icon">üìà</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-content">
                                <h3>Transa√ß√µes</h3>
                                <div class="stat-value" id="totalTransactionsValue">0</div>
                                <div class="stat-change">N√∫mero de vendas</div>
                            </div>
                            <div class="stat-icon">üî¢</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-content">
                                <h3>Clientes</h3>
                                <div class="stat-value" id="totalCustomersValue">0</div>
                                <div class="stat-change">Clientes cadastrados</div>
                            </div>
                            <div class="stat-icon">üë§</div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 style="margin-bottom: 16px; font-size: 16px; font-weight: 600;">√öltimas Transa√ß√µes</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Cliente</th>
                                        <th>Total</th>
                                        <th>Lucro</th>
                                        <th>Data</th>
                                    </tr>
                                </thead>
                                <tbody id="recentSalesTable">
                                    <tr>
                                        <td colspan="4" style="text-align: center; color: var(--text-tertiary);">Carregando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Products Page -->
                <div id="products" class="page">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="font-size: 20px; font-weight: 600;">Gerenciar Produtos</h2>
                        <button class="btn btn-primary" onclick="openProductModal()">+ Novo Produto</button>
                    </div>

                    <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                        <input type="text" id="productSearch" placeholder="Buscar produto..." onkeyup="filterProducts()">
                        <select id="categoryFilter" onchange="filterProducts()" style="width: 200px;">
                            <option value="">Todas as categorias</option>
                        </select>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Categoria</th>
                                    <th>Pre√ßo</th>
                                    <th>Custo</th>
                                    <th>Estoque</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="productsTable">
                                <tr>
                                    <td colspan="6" style="text-align: center; color: var(--text-tertiary);">Carregando...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Sales Page -->
                <div id="sales" class="page">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="font-size: 20px; font-weight: 600;">Nova Venda</h2>
                    </div>

                    <div class="form-row">
                        <div>
                            <label>Buscar Cliente</label>
                            <div class="customer-search">
                                <input type="text" id="customerSearch" placeholder="Digite nome ou telefone..." onkeyup="searchCustomers()">
                                <div class="search-results" id="searchResults"></div>
                            </div>
                            <div id="selectedCustomerInfo" style="background-color: var(--bg-secondary); border-radius: 8px; padding: 12px; margin-top: 12px; display: none;">
                                <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;" id="selectedCustomerName"></div>
                                <div style="font-size: 12px; color: var(--text-tertiary);" id="selectedCustomerPhone"></div>
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-secondary" onclick="openRegisterCustomerModal()" style="width: 100%; margin-top: 24px;">+ Cadastrar Cliente</button>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; margin: 24px 0;">
                        <input type="text" id="productSearchSales" placeholder="Buscar produto..." style="flex: 1;">
                        <select id="categoryFilterSales" style="width: 200px;">
                            <option value="">Todas as categorias</option>
                        </select>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 350px; gap: 24px;">
                        <div>
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Produtos Dispon√≠veis</h3>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Produto</th>
                                            <th>Pre√ßo</th>
                                            <th>Estoque</th>
                                            <th>A√ß√£o</th>
                                        </tr>
                                    </thead>
                                    <tbody id="productsTableSales">
                                        <tr>
                                            <td colspan="4" style="text-align: center; color: var(--text-tertiary);">Carregando...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div>
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Carrinho</h3>
                            <div id="cartItems" style="margin-bottom: 16px; max-height: 300px; overflow-y: auto;"></div>

                            <div class="cart-total">
                                <div style="font-size: 12px; color: var(--text-tertiary); margin-bottom: 4px;">Total</div>
                                <div id="cartTotal">R$ 0</div>
                                <div style="font-size: 12px; color: var(--success); margin-top: 8px;">Lucro: <span id="cartProfit">R$ 0</span></div>
                            </div>

                            <button class="btn btn-primary" onclick="completeSale()" style="width: 100%; margin-top: 12px;">Finalizar Venda</button>
                            <button class="btn btn-secondary" onclick="clearCart()" style="width: 100%; margin-top: 8px;">Limpar Carrinho</button>
                        </div>
                    </div>

                    <div class="chart-container" style="margin-top: 24px;">
                        <h3 style="margin-bottom: 16px; font-size: 16px; font-weight: 600;">Hist√≥rico de Vendas</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Cliente</th>
                                        <th>Total</th>
                                        <th>Lucro</th>
                                        <th>Data</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="salesHistoryTable">
                                    <tr>
                                        <td colspan="5" style="text-align: center; color: var(--text-tertiary);">Carregando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Customers Page -->
                <div id="customers" class="page">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="font-size: 20px; font-weight: 600;">Gerenciar Clientes</h2>
                        <button class="btn btn-primary" onclick="openRegisterCustomerModal()">+ Novo Cliente</button>
                    </div>

                    <div style="margin-bottom: 24px;">
                        <input type="text" id="customerSearchMain" placeholder="Buscar cliente..." onkeyup="filterCustomers()">
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Telefone</th>
                                    <th>Anivers√°rio</th>
                                    <th>Compras</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="customersTable">
                                <tr>
                                    <td colspan="5" style="text-align: center; color: var(--text-tertiary);">Carregando...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Messages Page -->
                <div id="messages" class="page">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="font-size: 20px; font-weight: 600;">Mensagens Pr√©-prontas</h2>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        <div>
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Anivers√°rios</h3>
                            <div id="birthdayMessages"></div>
                        </div>
                        <div>
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">Cole√ß√µes Novas</h3>
                            <div id="newCollectionMessages"></div>
                        </div>
                    </div>
                </div>

                <!-- Settings Page -->
                <div id="settings" class="page">
                    <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 24px;">Configura√ß√µes da Loja</h2>

                    <div style="background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 24px; max-width: 600px;">
                        <div class="form-group">
                            <label>Nome da Loja</label>
                            <input type="text" id="storeName" placeholder="Digite o nome da loja">
                        </div>

                        <div class="form-group">
                            <label>Descri√ß√£o</label>
                            <textarea id="storeDescription" placeholder="Descri√ß√£o da loja" rows="3"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Telefone WhatsApp</label>
                            <input type="tel" id="whatsappNumber" placeholder="(XX) 9XXXX-XXXX">
                        </div>

                        <div class="form-group">
                            <label>Logo da Loja (PNG, JPG)</label>
                            <div class="image-upload" onclick="document.getElementById('logoInput').click()">
                                <div style="font-size: 32px; margin-bottom: 8px;">üì∏</div>
                                <div>Clique ou arraste para upload</div>
                                <input type="file" id="logoInput" accept="image/*" style="display: none;" onchange="uploadLogo(event)">
                            </div>
                            <div id="logoPreview" style="margin-top: 12px;"></div>
                        </div>

                        <div class="form-group">
                            <label>Favicon (PNG, ICO)</label>
                            <div class="image-upload" onclick="document.getElementById('faviconInput').click()">
                                <div style="font-size: 32px; margin-bottom: 8px;">üîó</div>
                                <div>Clique ou arraste para upload</div>
                                <input type="file" id="faviconInput" accept="image/*" style="display: none;" onchange="uploadFavicon(event)">
                            </div>
                            <div id="faviconPreview" style="margin-top: 12px;"></div>
                        </div>

                        <button class="btn btn-primary" onclick="saveStoreSettings()" style="width: 100%;">Salvar Configura√ß√µes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Novo Produto</h2>
                <button class="close-btn" onclick="closeProductModal()">&times;</button>
            </div>

            <div class="form-group">
                <label>Nome do Produto</label>
                <input type="text" id="productName" placeholder="Digite o nome">
            </div>

            <div class="form-group">
                <label>Descri√ß√£o</label>
                <textarea id="productDescription" placeholder="Descri√ß√£o do produto" rows="3"></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Categoria</label>
                    <input type="text" id="productCategory" placeholder="Ex: Camisetas">
                </div>
                <div class="form-group">
                    <label>Estoque</label>
                    <input type="number" id="productStock" placeholder="0" min="0">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Pre√ßo de Venda (R$)</label>
                    <input type="number" id="productPrice" placeholder="0.00" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Custo (R$)</label>
                    <input type="number" id="productCost" placeholder="0.00" min="0" step="0.01">
                </div>
            </div>

            <div class="form-group">
                <label>Imagens do Produto (at√© 3)</label>
                <div class="image-upload" id="imageUploadZone" onclick="document.getElementById('productImages').click()">
                    <div style="font-size: 32px; margin-bottom: 8px;">üì∏</div>
                    <div>Clique ou arraste para upload</div>
                    <input type="file" id="productImages" accept="image/*" multiple style="display: none;" onchange="handleImageUpload(event)">
                </div>
                <div class="image-preview" id="imagePreview"></div>
            </div>

            <button class="btn btn-primary" onclick="saveProduct()" style="width: 100%; margin-top: 24px;">Salvar Produto</button>
        </div>
    </div>

    <!-- Customer Modal -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Cadastrar Cliente</h2>
                <button class="close-btn" onclick="closeCustomerModal()">&times;</button>
            </div>

            <div class="form-group">
                <label>Nome</label>
                <input type="text" id="customerName" placeholder="Nome completo">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Telefone</label>
                    <input type="tel" id="customerPhone" placeholder="(XX) 9XXXX-XXXX">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="customerEmail" placeholder="email@example.com">
                </div>
            </div>

            <div class="form-group">
                <label>Data de Anivers√°rio</label>
                <input type="date" id="customerBirthDate">
            </div>

            <div class="form-group">
                <label>Endere√ßo</label>
                <textarea id="customerAddress" placeholder="Rua, n√∫mero, complemento" rows="2"></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Cidade</label>
                    <input type="text" id="customerCity" placeholder="Cidade">
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <input type="text" id="customerState" placeholder="UF">
                </div>
            </div>

            <button class="btn btn-primary" onclick="saveCustomer()" style="width: 100%; margin-top: 24px;">Salvar Cliente</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ulykbxvtclrpmikhrbeh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVseWtieHZ0Y2xycG1pa2hyYmVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyMTI4MzUsImV4cCI6MjA3Nzc4ODgzNX0.tixzhXBVtPy1S61mhlxAEK4uqcbFqTY7qIheBtAGRUY';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Application state
        let currentTheme = localStorage.getItem('theme') || 'light';
        let currentPeriod = 'day';
        let currentCart = [];
        let selectedCustomerId = null;
        let allProducts = [];
        let allCustomers = [];
        let allMessages = [];

        document.addEventListener('DOMContentLoaded', async () => {
            setTheme(currentTheme);
            loadStoreSettings();
            loadDashboard();
            loadProducts();
            loadCustomers();
            loadMessages();
            loadCategories();
        });

        // Theme management
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(currentTheme);
            localStorage.setItem('theme', currentTheme);
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const themeBtn = document.querySelector('.theme-toggle');
            themeBtn.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
        }

        // Page switching
        function switchPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');

            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.menu-item').classList.add('active');

            const titles = {
                dashboard: 'Dashboard',
                products: 'Produtos',
                sales: 'Vendas',
                customers: 'Clientes',
                messages: 'Mensagens',
                settings: 'Configura√ß√µes'
            };
            document.getElementById('pageTitle').textContent = titles[pageId];

            if (pageId === 'dashboard') loadDashboard();
            if (pageId === 'products') loadProducts();
            if (pageId === 'sales') loadProductsForSales();
            if (pageId === 'customers') loadCustomers();
            if (pageId === 'messages') loadMessages();
        }

        async function loadDashboard() {
            try {
                const { data: sales, error } = await supabase
                    .from('sales')
                    .select('*')
                    .gte('created_at', getDateRange(currentPeriod).start);

                if (error) throw error;

                const totalSales = sales.reduce((sum, s) => sum + parseFloat(s.total_amount), 0);
                const totalProfit = sales.reduce((sum, s) => sum + parseFloat(s.total_profit), 0);
                const margin = totalSales > 0 ? ((totalProfit / totalSales) * 100).toFixed(1) : 0;

                document.getElementById('totalSalesValue').textContent = `R$ ${totalSales.toFixed(2)}`;
                document.getElementById('totalProfitValue').textContent = `R$ ${totalProfit.toFixed(2)}`;
                document.getElementById('profitMargin').textContent = margin;
                document.getElementById('totalTransactionsValue').textContent = sales.length;

                const { data: customers } = await supabase.from('customers').select('id');
                document.getElementById('totalCustomersValue').textContent = customers.length;

                const recentSales = sales.slice(-5).reverse();
                let html = '';
                for (const sale of recentSales) {
                    const customer = allCustomers.find(c => c.id === sale.customer_id);
                    html += `
                        <tr>
                            <td>${sale.customer_name}</td>
                            <td>R$ ${parseFloat(sale.total_amount).toFixed(2)}</td>
                            <td style="color: var(--success);">R$ ${parseFloat(sale.total_profit).toFixed(2)}</td>
                            <td>${new Date(sale.created_at).toLocaleDateString('pt-BR')}</td>
                        </tr>
                    `;
                }
                document.getElementById('recentSalesTable').innerHTML = html || '<tr><td colspan="4" style="text-align: center; color: var(--text-tertiary);">Nenhuma venda</td></tr>';
            } catch (error) {
                console.log('[v0] Dashboard error:', error.message);
            }
        }

        function getDateRange(period) {
            const now = new Date();
            let start = new Date();

            if (period === 'day') {
                start.setHours(0, 0, 0, 0);
            } else if (period === 'week') {
                start.setDate(now.getDate() - now.getDay());
                start.setHours(0, 0, 0, 0);
            } else if (period === 'month') {
                start.setDate(1);
                start.setHours(0, 0, 0, 0);
            }

            return { start: start.toISOString(), end: now.toISOString() };
        }

        function changePeriod(period) {
            currentPeriod = period;
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            loadDashboard();
        }

        async function loadProducts() {
            try {
                const { data, error } = await supabase
                    .from('products')
                    .select('*')
                    .eq('active', true);

                if (error) throw error;

                allProducts = data || [];
                displayProducts();
            } catch (error) {
                console.log('[v0] Load products error:', error.message);
            }
        }

        function displayProducts() {
            let html = '';
            for (const product of allProducts) {
                const profit = (parseFloat(product.price) - parseFloat(product.cost)).toFixed(2);
                html += `
                    <tr>
                        <td>${product.name}</td>
                        <td>${product.category}</td>
                        <td>R$ ${parseFloat(product.price).toFixed(2)}</td>
                        <td>R$ ${parseFloat(product.cost).toFixed(2)}</td>
                        <td>${product.stock_quantity}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="editProduct('${product.id}')">Editar</button>
                            <button class="btn" style="padding: 4px 8px; font-size: 12px; background-color: var(--danger); color: white;" onclick="deleteProduct('${product.id}')">Deletar</button>
                        </td>
                    </tr>
                `;
            }
            document.getElementById('productsTable').innerHTML = html || '<tr><td colspan="6" style="text-align: center; color: var(--text-tertiary);">Nenhum produto</td></tr>';
        }

        function filterProducts() {
            const search = document.getElementById('productSearch').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;

            const filtered = allProducts.filter(p => 
                (p.name.toLowerCase().includes(search)) &&
                (category === '' || p.category === category)
            );

            let html = '';
            for (const product of filtered) {
                const profit = (parseFloat(product.price) - parseFloat(product.cost)).toFixed(2);
                html += `
                    <tr>
                        <td>${product.name}</td>
                        <td>${product.category}</td>
                        <td>R$ ${parseFloat(product.price).toFixed(2)}</td>
                        <td>R$ ${parseFloat(product.cost).toFixed(2)}</td>
                        <td>${product.stock_quantity}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="editProduct('${product.id}')">Editar</button>
                            <button class="btn" style="padding: 4px 8px; font-size: 12px; background-color: var(--danger); color: white;" onclick="deleteProduct('${product.id}')">Deletar</button>
                        </td>
                    </tr>
                `;
            }
            document.getElementById('productsTable').innerHTML = html || '<tr><td colspan="6" style="text-align: center; color: var(--text-tertiary);">Nenhum produto encontrado</td></tr>';
        }

        function openProductModal() {
            document.getElementById('productModal').classList.add('active');
            document.getElementById('productName').value = '';
            document.getElementById('productDescription').value = '';
            document.getElementById('productCategory').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productCost').value = '';
            document.getElementById('productStock').value = '';
            document.getElementById('imagePreview').innerHTML = '';
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
        }

        function handleImageUpload(event) {
            const files = Array.from(event.target.files).slice(0, 3);
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';

            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'image-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button class="image-remove" onclick="removeImage(${index})">‚úï</button>
                    `;
                    preview.appendChild(div);
                    
                    // Store in data attribute
                    if (!window.productImages) window.productImages = [];
                    window.productImages[index] = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function removeImage(index) {
            if (window.productImages) {
                window.productImages.splice(index, 1);
            }
            document.getElementById('productImages').value = '';
            document.getElementById('imagePreview').innerHTML = '';
        }

        async function saveProduct() {
            const name = document.getElementById('productName').value.trim();
            const description = document.getElementById('productDescription').value.trim();
            const category = document.getElementById('productCategory').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value);
            const cost = parseFloat(document.getElementById('productCost').value);
            const stock = parseInt(document.getElementById('productStock').value) || 0;

            if (!name || !category || !price || !cost) {
                alert('Preencha todos os campos obrigat√≥rios');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('products')
                    .insert([{
                        name,
                        description,
                        category,
                        price,
                        cost,
                        stock_quantity: stock,
                        image_url_1: window.productImages?.[0] || null,
                        image_url_2: window.productImages?.[1] || null,
                        image_url_3: window.productImages?.[2] || null
                    }])
                    .select();

                if (error) throw error;

                alert('Produto salvo com sucesso!');
                closeProductModal();
                loadProducts();
                loadCategories();
            } catch (error) {
                alert('Erro ao salvar produto: ' + error.message);
            }
        }

        async function deleteProduct(id) {
            if (!confirm('Tem certeza que deseja deletar este produto?')) return;

            try {
                const { error } = await supabase
                    .from('products')
                    .update({ active: false })
                    .eq('id', id);

                if (error) throw error;

                alert('Produto removido com sucesso!');
                loadProducts();
            } catch (error) {
                alert('Erro ao deletar produto: ' + error.message);
            }
        }

        async function loadCategories() {
            try {
                const { data } = await supabase
                    .from('products')
                    .select('category')
                    .eq('active', true);

                const categories = [...new Set(data.map(p => p.category))];
                
                ['categoryFilter', 'categoryFilterSales'].forEach(id => {
                    const select = document.getElementById(id);
                    if (select) {
                        const currentValue = select.value;
                        select.innerHTML = '<option value="">Todas as categorias</option>';
                        categories.forEach(cat => {
                            select.innerHTML += `<option value="${cat}">${cat}</option>`;
                        });
                        select.value = currentValue;
                    }
                });
            } catch (error) {
                console.log('[v0] Load categories error:', error.message);
            }
        }

        async function loadCustomers() {
            try {
                const { data, error } = await supabase
                    .from('customers')
                    .select('*')
                    .eq('active', true);

                if (error) throw error;

                allCustomers = data || [];
                displayCustomers();
            } catch (error) {
                console.log('[v0] Load customers error:', error.message);
            }
        }

        function displayCustomers() {
            let html = '';
            for (const customer of allCustomers) {
                const birthDate = customer.birth_date ? new Date(customer.birth_date).toLocaleDateString('pt-BR') : '-';
                html += `
                    <tr>
                        <td>${customer.name}</td>
                        <td>${customer.phone}</td>
                        <td>${birthDate}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="viewCustomerHistory('${customer.id}')">Ver Hist√≥rico</button>
                        </td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="editCustomer('${customer.id}')">Editar</button>
                        </td>
                    </tr>
                `;
            }
            document.getElementById('customersTable').innerHTML = html || '<tr><td colspan="5" style="text-align: center; color: var(--text-tertiary);">Nenhum cliente</td></tr>';
        }

        function filterCustomers() {
            const search = document.getElementById('customerSearchMain').value.toLowerCase();
            const filtered = allCustomers.filter(c =>
                c.name.toLowerCase().includes(search) || c.phone.includes(search)
            );

            let html = '';
            for (const customer of filtered) {
                const birthDate = customer.birth_date ? new Date(customer.birth_date).toLocaleDateString('pt-BR') : '-';
                html += `
                    <tr>
                        <td>${customer.name}</td>
                        <td>${customer.phone}</td>
                        <td>${birthDate}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="viewCustomerHistory('${customer.id}')">Ver Hist√≥rico</button>
                        </td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="editCustomer('${customer.id}')">Editar</button>
                        </td>
                    </tr>
                `;
            }
            document.getElementById('customersTable').innerHTML = html || '<tr><td colspan="5" style="text-align: center; color: var(--text-tertiary);">Nenhum cliente encontrado</td></tr>';
        }

        function openRegisterCustomerModal() {
            document.getElementById('customerModal').classList.add('active');
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerBirthDate').value = '';
            document.getElementById('customerAddress').value = '';
            document.getElementById('customerCity').value = '';
            document.getElementById('customerState').value = '';
        }

        function closeCustomerModal() {
            document.getElementById('customerModal').classList.remove('active');
        }

        async function saveCustomer() {
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            const birthDate = document.getElementById('customerBirthDate').value;
            const address = document.getElementById('customerAddress').value.trim();
            const city = document.getElementById('customerCity').value.trim();
            const state = document.getElementById('customerState').value.trim();

            if (!name || !phone) {
                alert('Nome e telefone s√£o obrigat√≥rios');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('customers')
                    .insert([{
                        name,
                        phone,
                        email: email || null,
                        birth_date: birthDate || null,
                        address,
                        city,
                        state
                    }])
                    .select();

                if (error) throw error;

                // Select the newly created customer
                selectedCustomerId = data[0].id;
                document.getElementById('selectedCustomerInfo').style.display = 'block';
                document.getElementById('selectedCustomerName').textContent = name;
                document.getElementById('selectedCustomerPhone').textContent = phone;
                document.getElementById('customerSearch').value = '';

                alert('Cliente cadastrado com sucesso!');
                closeCustomerModal();
                loadCustomers();
            } catch (error) {
                alert('Erro ao salvar cliente: ' + error.message);
            }
        }

        async function viewCustomerHistory(customerId) {
            try {
                const { data, error } = await supabase
                    .from('sales')
                    .select('*')
                    .eq('customer_id', customerId);

                if (error) throw error;

                const customer = allCustomers.find(c => c.id === customerId);
                const totalSpent = data.reduce((sum, s) => sum + parseFloat(s.total_amount), 0);

                alert(`Hist√≥rico de ${customer.name}\n\nTotal de compras: ${data.length}\nTotal gasto: R$ ${totalSpent.toFixed(2)}`);
            } catch (error) {
                alert('Erro ao carregar hist√≥rico: ' + error.message);
            }
        }

        async function loadProductsForSales() {
            await loadProducts();
            displayProductsForSales();
        }

        function displayProductsForSales() {
            let html = '';
            for (const product of allProducts) {
                html += `
                    <tr>
                        <td>${product.name}</td>
                        <td>R$ ${parseFloat(product.price).toFixed(2)}</td>
                        <td>${product.stock_quantity}</td>
                        <td>
                            <input type="number" id="qty_${product.id}" min="1" value="1" max="${product.stock_quantity}" style="width: 60px;">
                            <button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;" onclick="addToCart('${product.id}')">+</button>
                        </td>
                    </tr>
                `;
            }
            document.getElementById('productsTableSales').innerHTML = html;
        }

        function addToCart(productId) {
            const product = allProducts.find(p => p.id === productId);
            const qty = parseInt(document.getElementById(`qty_${productId}`).value);

            if (qty > product.stock_quantity) {
                alert('Quantidade indispon√≠vel em estoque');
                return;
            }

            const existingItem = currentCart.find(item => item.id === productId);
            if (existingItem) {
                existingItem.quantity += qty;
            } else {
                currentCart.push({
                    id: productId,
                    name: product.name,
                    price: product.price,
                    cost: product.cost,
                    quantity: qty
                });
            }

            updateCartDisplay();
        }

        function updateCartDisplay() {
            let html = '';
            let total = 0;
            let totalCost = 0;

            for (const item of currentCart) {
                const subtotal = item.price * item.quantity;
                const subtotalCost = item.cost * item.quantity;
                total += subtotal;
                totalCost += subtotalCost;

                html += `
                    <div class="cart-item">
                        <div>
                            <div style="font-weight: 600; font-size: 14px;">${item.name}</div>
                            <div style="font-size: 12px; color: var(--text-tertiary);">Qtd: ${item.quantity} x R$ ${item.price.toFixed(2)}</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary" style="padding: 4px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;" onclick="removeFromCart('${item.id}')">‚àí</button>
                            <button class="btn" style="padding: 4px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background-color: var(--danger); color: white;" onclick="removeItemFromCart('${item.id}')">‚úï</button>
                        </div>
                    </div>
                `;
            }

            document.getElementById('cartItems').innerHTML = html;
            document.getElementById('cartTotal').textContent = `R$ ${total.toFixed(2)}`;
            document.getElementById('cartProfit').textContent = `R$ ${(total - totalCost).toFixed(2)}`;
        }

        function removeFromCart(productId) {
            const item = currentCart.find(i => i.id === productId);
            if (item.quantity > 1) {
                item.quantity--;
            } else {
                currentCart = currentCart.filter(i => i.id !== productId);
            }
            updateCartDisplay();
        }

        function removeItemFromCart(productId) {
            currentCart = currentCart.filter(i => i.id !== productId);
            updateCartDisplay();
        }

        function clearCart() {
            currentCart = [];
            updateCartDisplay();
            selectedCustomerId = null;
            document.getElementById('selectedCustomerInfo').style.display = 'none';
        }

        async function completeSale() {
            if (currentCart.length === 0) {
                alert('Carrinho vazio');
                return;
            }

            if (!selectedCustomerId) {
                alert('Selecione um cliente');
                return;
            }

            try {
                let totalAmount = 0;
                let totalCost = 0;

                for (const item of currentCart) {
                    totalAmount += item.price * item.quantity;
                    totalCost += item.cost * item.quantity;
                }

                const totalProfit = totalAmount - totalCost;
                const customer = allCustomers.find(c => c.id === selectedCustomerId);

                const { data: sale, error: saleError } = await supabase
                    .from('sales')
                    .insert([{
                        customer_id: selectedCustomerId,
                        customer_name: customer.name,
                        total_amount: totalAmount,
                        total_cost: totalCost,
                        total_profit: totalProfit
                    }])
                    .select();

                if (saleError) throw saleError;

                // Insert sale items
                for (const item of currentCart) {
                    const itemProfit = (item.price - item.cost) * item.quantity;
                    await supabase
                        .from('sale_items')
                        .insert([{
                            sale_id: sale[0].id,
                            product_id: item.id,
                            product_name: item.name,
                            quantity: item.quantity,
                            unit_price: item.price,
                            unit_cost: item.cost,
                            subtotal: item.price * item.quantity,
                            profit: itemProfit
                        }]);

                    // Update product stock
                    const product = allProducts.find(p => p.id === item.id);
                    await supabase
                        .from('products')
                        .update({ stock_quantity: product.stock_quantity - item.quantity })
                        .eq('id', item.id);
                }

                alert('Venda realizada com sucesso!');
                clearCart();
                loadProductsForSales();
                loadDashboard();
            } catch (error) {
                alert('Erro ao completar venda: ' + error.message);
            }
        }

        function searchCustomers() {
            const search = document.getElementById('customerSearch').value.toLowerCase();
            const results = document.getElementById('searchResults');

            if (search.length === 0) {
                results.innerHTML = '';
                return;
            }

            const filtered = allCustomers.filter(c =>
                c.name.toLowerCase().includes(search) || c.phone.includes(search)
            );

            let html = '';
            for (const customer of filtered) {
                html += `
                    <div class="search-result-item" onclick="selectCustomer('${customer.id}', '${customer.name}', '${customer.phone}')">
                        <div style="font-weight: 600;">${customer.name}</div>
                        <div style="font-size: 12px; color: var(--text-tertiary);">${customer.phone}</div>
                    </div>
                `;
            }

            results.innerHTML = html;
        }

        function selectCustomer(customerId, name, phone) {
            selectedCustomerId = customerId;
            document.getElementById('customerSearch').value = name;
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('selectedCustomerInfo').style.display = 'block';
            document.getElementById('selectedCustomerName').textContent = name;
            document.getElementById('selectedCustomerPhone').textContent = phone;
        }

        async function loadMessages() {
            try {
                const { data, error } = await supabase
                    .from('pre_made_messages')
                    .select('*')
                    .eq('active', true);

                if (error) throw error;

                allMessages = data || [];
                displayMessages();
            } catch (error) {
                console.log('[v0] Load messages error:', error.message);
            }
        }

        function displayMessages() {
            const birthdays = allMessages.filter(m => m.type === 'birthday');
            const collections = allMessages.filter(m => m.type === 'new_collection');

            let birthdayHtml = '';
            for (const msg of birthdays) {
                birthdayHtml += `
                    <div style="background-color: var(--bg-tertiary); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                        <div style="font-weight: 600; margin-bottom: 8px;">${msg.title}</div>
                        <div style="font-size: 14px; margin-bottom: 12px; line-height: 1.5;">${msg.content}</div>
                        <button class="btn btn-primary" style="width: 100%; font-size: 12px;" onclick="sendBirthdayMessages('${msg.id}')">Enviar para Aniversariantes</button>
                    </div>
                `;
            }

            let collectionHtml = '';
            for (const msg of collections) {
                collectionHtml += `
                    <div style="background-color: var(--bg-tertiary); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                        <div style="font-weight: 600; margin-bottom: 8px;">${msg.title}</div>
                        <div style="font-size: 14px; margin-bottom: 12px; line-height: 1.5;">${msg.content}</div>
                        <button class="btn btn-primary" style="width: 100%; font-size: 12px;" onclick="sendCollectionMessage('${msg.id}')">Enviar com Cole√ß√£o</button>
                    </div>
                `;
            }

            document.getElementById('birthdayMessages').innerHTML = birthdayHtml || '<div style="color: var(--text-tertiary);">Nenhuma mensagem</div>';
            document.getElementById('newCollectionMessages').innerHTML = collectionHtml || '<div style="color: var(--text-tertiary);">Nenhuma mensagem</div>';
        }

        async function sendBirthdayMessages(messageId) {
            const message = allMessages.find(m => m.id === messageId);
            const today = new Date().toISOString().split('T')[0];

            try {
                const birthdayCustomers = allCustomers.filter(c => {
                    if (!c.birth_date) return false;
                    const birthDate = c.birth_date.substring(5);
                    const currentDate = today.substring(5);
                    return birthDate === currentDate;
                });

                if (birthdayCustomers.length === 0) {
                    alert('Nenhum aniversariante hoje');
                    return;
                }

                for (const customer of birthdayCustomers) {
                    const whatsappLink = `https://wa.me/${customer.phone.replace(/\D/g, '')}?text=${encodeURIComponent(message.content)}`;
                    
                    await supabase
                        .from('message_history')
                        .insert([{
                            customer_id: customer.id,
                            message_template_id: messageId,
                            message_type: 'birthday',
                            message_content: message.content,
                            whatsapp_link: whatsappLink
                        }]);
                }

                alert(`Mensagens preparadas para ${birthdayCustomers.length} cliente(s)`);
            } catch (error) {
                alert('Erro ao enviar mensagens: ' + error.message);
            }
        }

        async function sendCollectionMessage(messageId) {
            const message = allMessages.find(m => m.id === messageId);
            
            try {
                const products = allProducts.slice(0, 3);
                
                if (products.length === 0) {
                    alert('Adicione produtos primeiro');
                    return;
                }

                for (const customer of allCustomers) {
                    let messageText = message.content + '\n\n';
                    
                    for (const product of products) {
                        messageText += `${product.name} - R$ ${product.price.toFixed(2)}\n`;
                    }

                    const whatsappLink = `https://wa.me/${customer.phone.replace(/\D/g, '')}?text=${encodeURIComponent(messageText)}`;
                    
                    await supabase
                        .from('message_history')
                        .insert([{
                            customer_id: customer.id,
                            message_template_id: messageId,
                            message_type: 'new_collection',
                            message_content: messageText,
                            whatsapp_link: whatsappLink
                        }]);
                }

                alert(`Mensagens de cole√ß√£o preparadas para ${allCustomers.length} cliente(s)`);
            } catch (error) {
                alert('Erro ao enviar mensagens: ' + error.message);
            }
        }

        async function loadStoreSettings() {
            try {
                const { data, error } = await supabase
                    .from('store_config')
                    .select('*')
                    .limit(1)
                    .single();

                if (error && error.code !== 'PGRST116') throw error;

                if (data) {
                    document.getElementById('storeName').value = data.store_name || 'Tamires Lima';
                    document.getElementById('storeDescription').value = data.store_description || '';
                    document.getElementById('whatsappNumber').value = data.whatsapp_number || '';
                    
                    if (data.logo_url) {
                        document.getElementById('logoPreview').innerHTML = `<img src="${data.logo_url}" style="max-width: 100px; border-radius: 8px;">`;
                    }
                    
                    if (data.favicon_url) {
                        document.getElementById('faviconPreview').innerHTML = `<img src="${data.favicon_url}" style="max-width: 50px; border-radius: 8px;">`;
                    }
                } else {
                    // Create default config
                    await supabase
                        .from('store_config')
                        .insert([{ store_name: 'Tamires Lima' }]);
                }
            } catch (error) {
                console.log('[v0] Load settings error:', error.message);
            }
        }

        async function uploadLogo(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('logoPreview').innerHTML = `<img src="${e.target.result}" style="max-width: 100px; border-radius: 8px;">`;
                window.logoData = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function uploadFavicon(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('faviconPreview').innerHTML = `<img src="${e.target.result}" style="max-width: 50px; border-radius: 8px;">`;
                window.faviconData = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function saveStoreSettings() {
            const name = document.getElementById('storeName').value.trim();
            const description = document.getElementById('storeDescription').value.trim();
            const whatsapp = document.getElementById('whatsappNumber').value.trim();

            try {
                const { error } = await supabase
                    .from('store_config')
                    .update({
                        store_name: name,
                        store_description: description,
                        whatsapp_number: whatsapp,
                        logo_url: window.logoData || null,
                        favicon_url: window.faviconData || null
                    })
                    .eq('id', (await supabase.from('store_config').select('id').limit(1).single()).data.id);

                if (error) throw error;

                alert('Configura√ß√µes salvas com sucesso!');
            } catch (error) {
                alert('Erro ao salvar configura√ß√µes: ' + error.message);
            }
        }

        function logoutUser() {
            alert('Logout realizado');
            // Future: Implement proper logout
        }

        window.productImages = [];
    </script>
</body>
</html>
